name: üîí DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# VARIABLES GLOBALES
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
env:
  DD_URL: http://localhost:8080
  # üîß Granularit√© des engagements : quarterly | monthly | weekly
  PERIOD_MODE: "quarterly"
  # üîß Security Gate : bloquer le pipeline si nouveaux Critical/High
  FAIL_ON_NEW_CRITICAL: "true"
  FAIL_ON_NEW_HIGH: "false"

jobs:
  security:
    name: üîç SAST + SCA + DAST + DefectDojo
    runs-on: self-hosted
    timeout-minutes: 120

    steps:

   
    - name: R√©cup√©rer le code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    
    - name: Installer jq
      run: |
        if command -v jq &> /dev/null; then
          echo " jq d√©j√† install√©: $(jq --version)"
          exit 0
        fi
        echo "üîß Nettoyage des processus apt bloqu√©s..."
        sudo killall apt apt-get dpkg 2>/dev/null || true
        sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock \
                   /var/cache/apt/archives/lock /var/lib/apt/lists/lock
        sudo dpkg --configure -a
        if sudo apt update -qq && sudo apt install -y -qq jq; then
          echo " jq install√© via apt: $(jq --version)"
        else
          echo "‚ö†Ô∏è √âchec apt, installation via binaire..."
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq && sudo mv jq /usr/local/bin/
          echo " jq install√© via binaire: $(jq --version)"
        fi

    - name:  Installer les d√©pendances Node
      working-directory: ./juice-shop
      run: |
        if [ -f "package-lock.json" ]; then
          echo " Installation avec npm ci..."
          npm ci
        else
          echo " Installation avec npm install..."
          npm install
        fi



    - name: üîç SAST avec Semgrep
      working-directory: ./juice-shop
      continue-on-error: true
      run: |
        [ -f ".semgrepignore" ] && mv .semgrepignore .semgrepignore.bak
        timeout 1500 docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep \
          --config=r/all --json --output=/src/semgrep-results.json \
          --metrics=off --jobs=4 --timeout=60 --max-memory=4096 /src || true
        [ -f ".semgrepignore.bak" ] && mv .semgrepignore.bak .semgrepignore
        [ ! -s "semgrep-results.json" ] && echo '{"results":[]}' > semgrep-results.json
    
        echo ""; echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "  üìä SEMGREP RAPPORT"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        jq -r '"  üîç Total: " + (.results | length | tostring) + 
              "\n  üî¥ High: " + ([.results[] | select(.extra.severity=="ERROR")] | length | tostring) +
              "\n  üü† Med: " + ([.results[] | select(.extra.severity=="WARNING")] | length | tostring) +
              "\n  üü° Low: " + ([.results[] | select(.extra.severity=="INFO")] | length | tostring)' semgrep-results.json
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "‚úÖ Pr√™t pour DefectDojo"


    - name:  Snyk SCA
      continue-on-error: true
      working-directory: ./juice-shop
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        echo " Scan Snyk en cours..."
        npx snyk test --severity-threshold=low \
          --json-file-output=snyk-results.json || true

        if [ ! -f "snyk-results.json" ] || [ ! -s "snyk-results.json" ]; then
          echo '{"vulnerabilities":[]}' > snyk-results.json
          echo " Fichier snyk-results.json cr√©√© (vide)"
        else
          COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
          echo " Snyk termin√© : $COUNT vuln√©rabilit√©s trouv√©es"
        fi

    - name:  Snyk Monitor
      continue-on-error: true
      working-directory: ./juice-shop
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        echo " Envoi des donn√©es √† Snyk Monitor..."
        npx snyk monitor || true

   
    - name:  D√©marrer l'API en arri√®re-plan
      working-directory: ./juice-shop
      run: |
        echo " D√©marrage de l'API sur http://localhost:3000"
        npm start &
        echo $! > api.pid
        sleep 15

        MAX_RETRIES=20
        for i in $(seq 1 $MAX_RETRIES); do
          if curl -s -f http://localhost:3000/ > /dev/null 2>&1; then
            echo " API d√©marr√©e avec succ√®s"
            exit 0
          fi
          echo " Tentative $i/$MAX_RETRIES..."
          sleep 3
        done
        echo " API n'a pas d√©marr√©"
        exit 1

  
    - name:  DAST - Scan OpenAPI
      working-directory: ./juice-shop
      continue-on-error: true
      run: |
        echo " Scan OpenAPI avec ZAP..."
    
        if [ -f ".zap/rules.tsv" ]; then
          echo "üìã Utilisation des r√®gles: .zap/rules.tsv"
          RULES_FILE="-c .zap/rules.tsv"
        else
          RULES_FILE=""
        fi
    
        API_FILE=""
        for file in swagger.yml swagger.yaml openapi.json swagger.json; do
          if [ -f "$file" ]; then
            API_FILE="$file"
            echo "‚úÖ Fichier OpenAPI trouv√©: $file"
            break
          fi
        done

        if [ -n "$API_FILE" ]; then
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t http://localhost:3000 \
            -f openapi \
            -d /zap/wrk/$API_FILE \          
            -x /zap/wrk/zap-openapi.xml \
            -J /zap/wrk/zap-openapi.json \
            $RULES_FILE \
            -T 30 \
            -I || true
        else
          echo "‚ö†Ô∏è Aucun fichier OpenAPI trouv√©, scan sans sp√©cification"
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t http://localhost:3000 \
            -f openapi \
            -x /zap/wrk/zap-openapi.xml \
            -J /zap/wrk/zap-openapi.json \
            $RULES_FILE \
            -T 30 \
            -I || true
        fi

    - name:  V√©rifier rapport OpenAPI
      working-directory: ./juice-shop
      run: |
        if [ -f zap-openapi.json ]; then 
          echo "‚úÖ zap-openapi.json trouv√©"
          echo "Taille: $(stat -c%s zap-openapi.json 2>/dev/null || stat -f%z zap-openapi.json 2>/dev/null) octets"
        elif [ -f zap_out.json ]; then 
          cp zap_out.json zap-openapi.json
          echo "‚úÖ Renomm√© zap_out.json en zap-openapi.json"
        elif [ -f report_json.json ]; then 
          cp report_json.json zap-openapi.json
          echo "‚úÖ Renomm√© report_json.json en zap-openapi.json"
        else 
          echo "‚ö†Ô∏è Aucun rapport OpenAPI trouv√©"
          echo "[]" > zap-openapi.json
        fi

    - name:  DAST - Spider Scan
      continue-on-error: true
      timeout-minutes: 30
      working-directory: ./juice-shop
      run: |
        echo " Spider Scan avec r√®gles personnalis√©es..."
    
        if [ -f ".zap/rules.tsv" ]; then
          echo "üìã Utilisation du fichier de r√®gles: .zap/rules.tsv"
          echo "R√®gles configur√©es:"
          grep "IGNORE" .zap/rules.tsv | head -5
          RULES_FILE="-c .zap/rules.tsv"
        else
          RULES_FILE=""
        fi
    
        docker run --rm --network host -v $(pwd):/zap/wrk:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py \
          -t http://localhost:3000 \
          $RULES_FILE \
          -x /zap/wrk/zap-spider.xml \
          -J /zap/wrk/zap-spider.json \
          -T 15 \
          -m 2 || echo " Scan termin√©"

    - name:  V√©rifier rapport Spider
      working-directory: ./juice-shop
      run: |
        if [ -f zap-spider.json ]; then 
          echo "‚úÖ zap-spider.json trouv√©"
        elif [ -f zap-out.json ]; then 
          cp zap-out.json zap-spider.json
          echo "‚úÖ Renomm√© zap-out.json en zap-spider.json"
        else 
          echo "‚ö†Ô∏è Aucun rapport Spider trouv√©"
          echo "[]" > zap-spider.json
        fi


    - name:  DAST - Active Scan
      continue-on-error: true
      timeout-minutes: 40
      working-directory: ./juice-shop
      run: |
        echo " Scan actif avec ZAP (peut prendre 30-40 minutes)..."
    
        if [ -f ".zap/rules.tsv" ]; then
          echo "üìã Utilisation des r√®gles pour l'Active Scan"
          RULES_FILE="-c .zap/rules.tsv"
        else
          RULES_FILE=""
        fi
    
        docker run --rm --network host -v $(pwd):/zap/wrk:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t http://localhost:3000 \
          -x /zap/wrk/zap-active.xml \
          -J /zap/wrk/zap-active.json \
          $RULES_FILE \
          -T 30 || true

    - name:  V√©rifier rapport Active Scan
      working-directory: ./juice-shop
      run: |
        if [ -f zap-active.json ]; then 
          echo "‚úÖ zap-active.json trouv√©"
        elif [ -f zap-out.json ]; then 
          cp zap-out.json zap-active.json
          echo "‚úÖ Renomm√© zap-out.json en zap-active.json"
        else 
          echo "‚ö†Ô∏è Aucun rapport Active Scan trouv√©"
          echo "[]" > zap-active.json
        fi

    - name:  Consolider les rapports DAST
      working-directory: ./juice-shop
      run: |
        echo " Consolidation des rapports DAST..."
        echo "[]" > zap-consolidated.json
        if ls zap-*.json 1> /dev/null 2>&1; then
          jq -s 'add' zap-*.json > zap-consolidated.json 2>/dev/null || echo "[]" > zap-consolidated.json
        fi

        if [ -s zap-consolidated.json ]; then
          TOTAL=$(jq 'length' zap-consolidated.json 2>/dev/null || echo "0")
          CRITICAL=$(jq '[.[] | select(.riskcode=="3")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.[] | select(.riskcode=="2")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.[] | select(.riskcode=="1")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          LOW=$(jq '[.[] | select(.riskcode=="0")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          echo " R√âSULTATS DAST:"
          echo "   Total    : $TOTAL vuln√©rabilit√©s"
          echo "   üî¥ Critiques : $CRITICAL"
          echo "   üü† Hautes    : $HIGH"
          echo "   üü° Moyennes  : $MEDIUM"
          echo "   üü¢ Basses    : $LOW"
        else
          echo " Aucune vuln√©rabilit√© consolid√©e"
        fi

   
    - name:  Arr√™ter l'API
      if: always()
      working-directory: ./juice-shop
      run: |
        echo " Arr√™t de l'API..."
        if [ -f api.pid ]; then
          PID=$(cat api.pid)
          kill $PID 2>/dev/null || true
          rm -f api.pid
          echo " API arr√™t√©e (PID: $PID)"
        fi
        pkill -f "node.*juice-shop" || true
        echo " Nettoyage des processus termin√©"

   
    - name:  Upload tous les rapports de s√©curit√©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: |
          juice-shop/semgrep-results.json
          juice-shop/snyk-results.json
          juice-shop/zap-*.json
          juice-shop/zap-*.xml
          juice-shop/.zap/rules.tsv
        retention-days: 30
        if-no-files-found: warn

    
    - name:  DefectDojo ‚Äî R√©soudre l'Engagement
      if: always()
      id: dd_engagement
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
      run: |
        BRANCH="${{ github.ref_name }}"
        TODAY=$(date +%Y-%m-%d)

        # ‚îÄ‚îÄ Calcul de la p√©riode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if [ "$PERIOD_MODE" = "quarterly" ]; then
          MONTH=$(date +%-m)
          YEAR=$(date +%Y)
          if   [ $MONTH -le 3  ]; then PERIOD="Q1"; PERIOD_START="$YEAR-01-01"; PERIOD_END="$YEAR-03-31"
          elif [ $MONTH -le 6  ]; then PERIOD="Q2"; PERIOD_START="$YEAR-04-01"; PERIOD_END="$YEAR-06-30"
          elif [ $MONTH -le 9  ]; then PERIOD="Q3"; PERIOD_START="$YEAR-07-01"; PERIOD_END="$YEAR-09-30"
          else                         PERIOD="Q4"; PERIOD_START="$YEAR-10-01"; PERIOD_END="$YEAR-12-31"
          fi
          ENGAGEMENT_NAME="$BRANCH ‚Äî $YEAR-$PERIOD"

        elif [ "$PERIOD_MODE" = "monthly" ]; then
          PERIOD=$(date +%Y-%m)
          PERIOD_START=$(date +%Y-%m-01)
          PERIOD_END=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%Y-%m-%d)
          ENGAGEMENT_NAME="$BRANCH ‚Äî $PERIOD"

        elif [ "$PERIOD_MODE" = "weekly" ]; then
          PERIOD="W$(date +%V)-$(date +%Y)"
          PERIOD_START=$(date -d "last Monday" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          PERIOD_END=$(date -d "next Sunday" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          ENGAGEMENT_NAME="$BRANCH ‚Äî $PERIOD"
        fi

        echo "üìÖ Mode       : $PERIOD_MODE"
        echo "üè∑Ô∏è  Engagement : $ENGAGEMENT_NAME"
        echo "üìÜ P√©riode    : $PERIOD_START ‚Üí $PERIOD_END"

        # ‚îÄ‚îÄ Recherche d'un engagement existant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        ENCODED_NAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$ENGAGEMENT_NAME'))")
        SEARCH=$(curl -s \
          "$DD_URL/api/v2/engagements/?product=$PRODUCT_ID&name=$ENCODED_NAME&status=In Progress" \
          -H "Authorization: Token $DD_API_KEY")

        COUNT=$(echo "$SEARCH" | python3 -c "import sys,json; print(json.load(sys.stdin)['count'])")

        if [ "$COUNT" -gt "0" ]; then
          # ‚ôªÔ∏è R√©utilisation
          ENGAGEMENT_ID=$(echo "$SEARCH" | python3 -c "
        import sys, json
        results = json.load(sys.stdin)['results']
        results.sort(key=lambda x: x['id'], reverse=True)
        print(results[0]['id'])
          ")
          echo "‚ôªÔ∏è  Engagement existant r√©utilis√© ‚Äî ID: $ENGAGEMENT_ID"

          # Mise √† jour de la tra√ßabilit√©
          curl -s -X PATCH "$DD_URL/api/v2/engagements/$ENGAGEMENT_ID/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"target_end\": \"$PERIOD_END\",
              \"commit_hash\": \"${{ github.sha }}\",
              \"build_id\": \"${{ github.run_id }}\"
            }" > /dev/null

          echo "ENGAGEMENT_STATUS=reused" >> $GITHUB_ENV

        else
          #  Cr√©ation
          echo " Cr√©ation d'un nouvel engagement : $ENGAGEMENT_NAME"

          CREATE=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"$ENGAGEMENT_NAME\",
              \"description\": \"Scans CI/CD automatis√©s | Branche: $BRANCH | P√©riode: $PERIOD_START ‚Üí $PERIOD_END\",
              \"product\": $PRODUCT_ID,
              \"engagement_type\": \"CI/CD\",
              \"status\": \"In Progress\",
              \"target_start\": \"$PERIOD_START\",
              \"target_end\": \"$PERIOD_END\",
              \"branch_tag\": \"$BRANCH\",
              \"commit_hash\": \"${{ github.sha }}\",
              \"build_id\": \"${{ github.run_id }}\",
              \"deduplication_on_engagement\": false,
              \"tags\": [\"github-actions\", \"$BRANCH\", \"$PERIOD_MODE\", \"$PERIOD\", \"automated\"]
            }")

          ENGAGEMENT_ID=$(echo "$CREATE" | python3 -c "
        import sys, json
        d = json.load(sys.stdin)
        if 'id' in d:
            print(d['id'])
        else:
            print(f'ERREUR cr√©ation: {d}', file=__import__('sys').stderr)
            sys.exit(1)
          ")

          echo " Engagement cr√©√© ‚Äî ID: $ENGAGEMENT_ID"
          echo "ENGAGEMENT_STATUS=created" >> $GITHUB_ENV
        fi

        # Exports pour les steps suivants
        echo "ENGAGEMENT_ID=$ENGAGEMENT_ID"       >> $GITHUB_ENV
        echo "engagement_id=$ENGAGEMENT_ID"       >> $GITHUB_OUTPUT
        echo "ENGAGEMENT_NAME=$ENGAGEMENT_NAME"   >> $GITHUB_ENV

   
    - name:  DefectDojo ‚Äî Snapshot avant import
      if: always()
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        echo " Capture des findings actifs AVANT r√©import..."

        TOTAL=$(curl -s \
          "$DD_URL/api/v2/findings/?engagement=$ENGAGEMENT_ID&active=true&limit=1" \
          -H "Authorization: Token $DD_API_KEY" | \
          python3 -c "import sys,json; print(json.load(sys.stdin)['count'])" 2>/dev/null || echo "0")

        echo "FINDINGS_BEFORE=$TOTAL" >> $GITHUB_ENV

        for SEV in Critical High Medium Low Info; do
          COUNT=$(curl -s \
            "$DD_URL/api/v2/findings/?engagement=$ENGAGEMENT_ID&active=true&severity=$SEV&limit=1" \
            -H "Authorization: Token $DD_API_KEY" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)['count'])" 2>/dev/null || echo "0")
          echo "BEFORE_${SEV}=$COUNT" >> $GITHUB_ENV
          echo "  ‚Ä¢ $SEV : $COUNT"
        done

        echo " Total avant : $TOTAL findings actifs"

 
    - name:  DefectDojo ‚Äî R√©import des scans
      if: always()
      continue-on-error: true
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |

        reimport_scan() {
          local file="$1"
          local scan_type="$2"
          local test_title="$3"
          local category="$4"    

          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "    $test_title ‚Äî fichier absent ou vide, skip"
            return 0
          fi

          RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/reimport-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=$scan_type" \
            -F "test_title=$test_title" \
            -F "file=@$file" \
            -F "active=true" \
            -F "verified=false" \
            -F "close_old_findings=true" \
            -F "close_old_findings_product_scope=false" \
            -F "minimum_severity=Info" \
            -F "environment=Development" \
            -F "branch_tag=${{ github.ref_name }}" \
            -F "commit_hash=${{ github.sha }}" \
            -F "build_id=${{ github.run_id }}" \
            -F "tags=$category,github-actions,automated" \
            2>&1) || true

          python3 - << PYEOF
        import json, sys
        raw = r"""$RESPONSE"""
        try:
            d = json.loads(raw)
            if "id" in d:
                new_f    = d.get("finding_count", 0)
                closed_f = d.get("closed_findings", 0)
                skip_f   = d.get("skipped_findings", 0)
                test_id  = d.get("test", "?")
                print(f"  ‚úÖ $test_title | Test ID: {test_id} | new={new_f} closed={closed_f} skipped={skip_f}")
            else:
                print(f"  ‚ùå $test_title | Erreur API: {d}")
        except Exception as e:
            print(f"  ‚ùå $test_title | Parse error: {e}")
            print(f"     R√©ponse brute: {raw[:300]}")
        PYEOF
        }

        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "  üî¨ SAST ‚Äî Static Application Security Testing"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        reimport_scan \
          "juice-shop/semgrep-results.json" \
          "Semgrep JSON Report" \
          "SAST ‚Äî Semgrep" \
          "SAST"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "  üì¶ SCA ‚Äî Software Composition Analysis"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        reimport_scan \
          "juice-shop/snyk-results.json" \
          "Snyk Scan" \
          "SCA ‚Äî Snyk" \
          "SCA"

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "  üåê DAST ‚Äî Dynamic Application Security Testing"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        reimport_scan \
          "juice-shop/zap-openapi.xml" \
          "ZAP Scan" \
          "DAST ‚Äî ZAP OpenAPI" \
          "DAST"

        reimport_scan \
          "juice-shop/zap-spider.xml" \
          "ZAP Scan" \
          "DAST ‚Äî ZAP Spider" \
          "DAST"

        reimport_scan \
          "juice-shop/zap-active.xml" \
          "ZAP Scan" \
          "DAST ‚Äî ZAP Active Scan" \
          "DAST"

   
    - name:  DefectDojo ‚Äî Rapport final & Security Gate
      if: always()
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        python3 - << 'PYEOF'
        import urllib.request, json, os, sys

        dd_url      = os.environ["DD_URL"]
        token       = os.environ["DD_API_KEY"]
        eng         = os.environ["ENGAGEMENT_ID"]
        eng_name    = os.environ["ENGAGEMENT_NAME"]
        eng_status  = os.environ["ENGAGEMENT_STATUS"]
        before      = int(os.environ.get("FINDINGS_BEFORE", 0))
        fail_crit   = os.environ.get("FAIL_ON_NEW_CRITICAL", "true") == "true"
        fail_high   = os.environ.get("FAIL_ON_NEW_HIGH", "false")    == "true"

        severities  = ["Critical", "High", "Medium", "Low", "Info"]
        icons       = {"Critical": "üî¥", "High": "üü†", "Medium": "üü°", "Low": "üîµ", "Info": "‚ö™"}

        headers = {"Authorization": f"Token {token}"}

        def fetch(url):
            req = urllib.request.Request(url, headers=headers)
            with urllib.request.urlopen(req) as r:
                return json.loads(r.read())

        # Snapshot APR√àS par s√©v√©rit√©
        before_counts = {s: int(os.environ.get(f"BEFORE_{s}", 0)) for s in severities}
        after_counts  = {}
        total_after   = 0

        for sev in severities:
            try:
                r = fetch(f"{dd_url}/api/v2/findings/?engagement={eng}&active=true&severity={sev}&limit=1")
                after_counts[sev] = r["count"]
                total_after += r["count"]
            except:
                after_counts[sev] = "?"

        total_diff = total_after - before if isinstance(total_after, int) else "?"

        print("")
        print("‚ïê" * 58)
        print("    DEFECTDOJO ‚Äî RAPPORT DE S√âCURIT√â CI/CD")
        print("‚ïê" * 58)
        print(f"  Engagement  : {eng_name}")
        print(f"  Statut      : {'üÜï Cr√©√© ce run' if eng_status == 'created' else '‚ôªÔ∏è  R√©utilis√© (existant)'}")
        print(f"  Branche     : ${{ github.ref_name }}")
        print(f"  Commit      : ${{ github.sha }}"[:52] + "...")
        print(f"  Run ID      : ${{ github.run_id }}")
        print("")

        # Tableau de delta
        print(f"  {'S√©v√©rit√©':<12} ‚îÇ {'Avant':>5} ‚îÇ {'Apr√®s':>5} ‚îÇ Delta")
        print(f"  {'‚îÄ'*12}‚îÄ‚îº‚îÄ{'‚îÄ'*5}‚îÄ‚îº‚îÄ{'‚îÄ'*5}‚îÄ‚îº‚îÄ{'‚îÄ'*8}")

        new_critical = 0
        new_high     = 0

        for sev in severities:
            b = before_counts[sev]
            a = after_counts[sev]
            if isinstance(a, int) and isinstance(b, int):
                diff = a - b
                delta_str  = f"+{diff}" if diff > 0 else str(diff)
                delta_icon = " üî∫" if diff > 0 else (" ‚úÖ" if diff < 0 else "  ‚Äî")
                if sev == "Critical": new_critical = max(0, diff)
                if sev == "High":     new_high     = max(0, diff)
            else:
                delta_str, delta_icon = "?", ""
            print(f"  {icons[sev]} {sev:<10} ‚îÇ {str(b):>5} ‚îÇ {str(a):>5} ‚îÇ {delta_str}{delta_icon}")

        print("")
        print(f"  Total actifs avant ce run : {before}")
        print(f"  Total actifs apr√®s ce run : {total_after}")

        # Message de changement
        if total_diff == 0:
            print("")
            print("  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
            print("  ‚îÇ  ‚ÑπÔ∏è  AUCUN CHANGEMENT d√©tect√© dans ce run     ‚îÇ")
            print("  ‚îÇ  Les findings sont identiques au run         ‚îÇ")
            print("  ‚îÇ  pr√©c√©dent. Engagement mis √† jour.           ‚îÇ")
            print("  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        elif isinstance(total_diff, int) and total_diff > 0:
            print(f"\n  üî∫ {total_diff} nouveau(x) finding(s) d√©tect√©(s) ce run !")
        elif isinstance(total_diff, int) and total_diff < 0:
            print(f"\n  üü¢ {abs(total_diff)} finding(s) r√©solu(s) depuis le dernier run !")

        print("")
        print(f"  üîó {dd_url}/engagements/{eng}/finding/")
        print("‚ïê" * 58)

        # ‚îÄ‚îÄ Security Gate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        exit_code = 0

        if fail_crit and new_critical > 0:
            print(f"\nüö® SECURITY GATE FAILED !")
            print(f"   {new_critical} nouveau(x) finding(s) CRITICAL introduit(s).")
            print(f"   ‚ûú Corrige les vuln√©rabilit√©s critiques avant de merger.")
            exit_code = 1

        if fail_high and new_high > 0:
            print(f"\n‚õî SECURITY GATE FAILED !")
            print(f"   {new_high} nouveau(x) finding(s) HIGH introduit(s).")
            exit_code = 1

        if exit_code == 0 and (not fail_crit or new_critical == 0) and (not fail_high or new_high == 0):
            print("\n‚úÖ Security Gate : PASSED")

        sys.exit(exit_code)
        PYEOF

    
    - name:  Pipeline termin√©
      if: always()
      run: |
        echo " DevSecOps pipeline ex√©cut√© avec succ√®s"
        echo "   Branche  : ${{ github.ref_name }}"
        echo "   Commit   : ${{ github.sha }}"
        echo "   Run ID   : ${{ github.run_id }}"
        echo "   DefectDojo Engagement : $ENGAGEMENT_NAME (ID: $ENGAGEMENT_ID)"