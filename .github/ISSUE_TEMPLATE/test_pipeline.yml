name: ðŸ§ª Test DefectDojo (Engagement uniquement)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DD_URL: http://localhost:8080

jobs:
  test-engagement:
    runs-on: self-hosted
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Ã‰tape 1 : VÃ©rification de l'accessibilitÃ© de l'API
      - name: VÃ©rifier l'accÃ¨s Ã  l'API DefectDojo
        env:
          DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        run: |
          echo "ðŸ” Test de connexion Ã  l'API..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$DD_URL/api/v2/engagements/?limit=1" \
            -H "Authorization: Token $DD_API_KEY")
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… API accessible (HTTP 200)"
          else
            echo "âŒ Ã‰chec de connexion Ã  l'API (HTTP $RESPONSE)"
            exit 1
          fi

      # Ã‰tape 2 : RÃ©solution de l'engagement (crÃ©ation ou rÃ©utilisation)
      - name: DÃ©finir ou crÃ©er l'engagement
        id: dd_engagement
        env:
          DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
        run: |
          set -e
          BRANCH="${{ github.ref_name }}"
          YEAR=$(date +%Y)
          MONTH=$(date +%-m)

          # DÃ©terminer le trimestre
          if   [ $MONTH -le 3 ]; then PERIOD="Q1"; PERIOD_START="$YEAR-01-01"; PERIOD_END="$YEAR-03-31"
          elif [ $MONTH -le 6 ]; then PERIOD="Q2"; PERIOD_START="$YEAR-04-01"; PERIOD_END="$YEAR-06-30"
          elif [ $MONTH -le 9 ]; then PERIOD="Q3"; PERIOD_START="$YEAR-07-01"; PERIOD_END="$YEAR-09-30"
          else                        PERIOD="Q4"; PERIOD_START="$YEAR-10-01"; PERIOD_END="$YEAR-12-31"
          fi

          ENGAGEMENT_NAME="${BRANCH} â€” ${YEAR}-${PERIOD} (test rapide)"
          echo "ðŸ·ï¸  Engagement cible : $ENGAGEMENT_NAME"

          # âœ… Fix : encodage via variable d'environnement pour Ã©viter les problÃ¨mes de guillemets/caractÃ¨res spÃ©ciaux
          ENCODED_NAME=$(python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))" "$ENGAGEMENT_NAME")

          # Encodage du status pour l'URL
          ENCODED_STATUS=$(python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))" "In Progress")

          SEARCH_URL="$DD_URL/api/v2/engagements/?product=$PRODUCT_ID&name=$ENCODED_NAME&status=$ENCODED_STATUS"

          # Recherche d'un engagement existant
          SEARCH_RESP=$(curl -s "$SEARCH_URL" -H "Authorization: Token $DD_API_KEY")
          COUNT=$(echo "$SEARCH_RESP" | jq -r '.count // 0')

          if [ "$COUNT" -gt 0 ]; then
            ENGAGEMENT_ID=$(echo "$SEARCH_RESP" | jq -r '.results | sort_by(.id) | reverse | .[0].id')
            echo "â™»ï¸  Engagement existant rÃ©utilisÃ© â€” ID: $ENGAGEMENT_ID"
            curl -s -X PATCH "$DD_URL/api/v2/engagements/$ENGAGEMENT_ID/" \
              -H "Authorization: Token $DD_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"target_end\": \"$PERIOD_END\"}" > /dev/null
          else
            CREATE_RESP=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
              -H "Authorization: Token $DD_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"name\": \"$ENGAGEMENT_NAME\",
                \"product\": $PRODUCT_ID,
                \"target_start\": \"$PERIOD_START\",
                \"target_end\": \"$PERIOD_END\",
                \"status\": \"In Progress\",
                \"engagement_type\": \"CI/CD\"
              }")
            ENGAGEMENT_ID=$(echo "$CREATE_RESP" | jq -r '.id')
            if [ -z "$ENGAGEMENT_ID" ] || [ "$ENGAGEMENT_ID" = "null" ]; then
              echo "âŒ Ã‰chec de crÃ©ation de l'engagement. RÃ©ponse API :"
              echo "$CREATE_RESP"
              exit 1
            fi
            echo "âœ… Nouvel engagement crÃ©Ã© â€” ID: $ENGAGEMENT_ID"
          fi

          echo "ENGAGEMENT_ID=$ENGAGEMENT_ID" >> $GITHUB_ENV
          echo "engagement_id=$ENGAGEMENT_ID" >> $GITHUB_OUTPUT
          echo "ENGAGEMENT_NAME=$ENGAGEMENT_NAME" >> $GITHUB_ENV

      - name: Affichage du rÃ©sultat
        run: |
          echo "ðŸŽ¯ Engagement utilisÃ© : $ENGAGEMENT_NAME (ID: $ENGAGEMENT_ID)"
          echo "ðŸ”— Lien : $DD_URL/engagements/$ENGAGEMENT_ID/finding/"