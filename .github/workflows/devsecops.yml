name: DevSecOps Pipeline - InvisiThreat (OptimisÃ©)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# ============================================
# JOB 1 : SAST (Semgrep) - 10 minutes max
# ============================================
jobs:
  sast:
    name: ğŸ” SAST - Semgrep
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then 
            echo "âœ… jq dÃ©jÃ  installÃ©"
            exit 0 
          fi
          echo "ğŸ“¦ Installation de jq..."
          sudo killall apt apt-get dpkg 2>/dev/null || true
          sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock /var/lib/apt/lists/lock
          sudo dpkg --configure -a
          if sudo apt update -qq && sudo apt install -y -qq jq; then
            echo "âœ… jq installÃ© avec apt"
            exit 0
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/
          echo "âœ… jq installÃ© via binaire"

      - name: Check Docker images
        run: |
          if ! docker image inspect returntocorp/semgrep:latest >/dev/null 2>&1; then
            echo "ğŸ“¦ Image Semgrep non trouvÃ©e, tÃ©lÃ©chargement..."
            docker pull returntocorp/semgrep:latest
          else
            IMAGE_SIZE=$(docker images returntocorp/semgrep:latest --format "{{.Size}}" 2>/dev/null || echo "inconnue")
            echo "âœ… Image Semgrep dÃ©jÃ  prÃ©sente ($IMAGE_SIZE)"
          fi

      - name: SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          echo "ğŸ” Scan Semgrep en cours..."
          START_TIME=$(date +%s)
          
          docker run --rm -v $(pwd):/src returntocorp/semgrep:latest semgrep \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            /src || true
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          if [ ! -f "semgrep-results.json" ] || [ ! -s "semgrep-results.json" ]; then
            echo '{"results":[]}' > semgrep-results.json
            echo "âš ï¸ Fichier semgrep-results.json crÃ©Ã© (vide)"
          else
            COUNT=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "âœ… Semgrep terminÃ© en ${DURATION}s : $COUNT rÃ©sultats"
          fi

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: juice-shop/semgrep-results.json
          retention-days: 30
          if-no-files-found: warn

# ============================================
# JOB 2 : SCA (Snyk) - 10 minutes max
# ============================================
  sca:
    name: ğŸ“¦ SCA - Snyk
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then 
            echo "âœ… jq dÃ©jÃ  installÃ©"
            exit 0 
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/
          echo "âœ… jq installÃ©"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            juice-shop/node_modules
            ~/.npm
          key: ${{ runner.os }}-modules-${{ hashFiles('juice-shop/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: Install dependencies (robuste)
        working-directory: ./juice-shop
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          START_TIME=$(date +%s)
          
          # VÃ©rifier si node_modules existe dÃ©jÃ  (cache)
          if [ -d "node_modules" ] && [ -f "node_modules/.lock-hash" ] && [ -f "package-lock.json" ]; then
            CURRENT_HASH=$(md5sum package-lock.json | cut -d' ' -f1)
            SAVED_HASH=$(cat node_modules/.lock-hash 2>/dev/null || echo "")
            
            if [ "$CURRENT_HASH" = "$SAVED_HASH" ]; then
              echo "âœ… DÃ©pendances dÃ©jÃ  Ã  jour (cache valide)"
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              echo "â±ï¸  VÃ©rification terminÃ©e en ${DURATION}s"
              exit 0
            fi
          fi
          
          # Installation propre
          if [ -f "package-lock.json" ] && [ -s "package-lock.json" ]; then
            echo "ğŸ“„ package-lock.json trouvÃ©, utilisation de npm ci..."
            if npm ci --prefer-offline --no-audit --no-fund; then
              echo "âœ… Installation rÃ©ussie avec npm ci"
              md5sum package-lock.json > node_modules/.lock-hash
            else
              echo "âš ï¸ npm ci a Ã©chouÃ©, utilisation de npm install..."
              rm -f package-lock.json
              npm install --no-package-lock
            fi
          else
            echo "âš ï¸ package-lock.json non trouvÃ©, utilisation de npm install..."
            npm install --no-package-lock
            
            # GÃ©nÃ©rer package-lock.json pour le prochain run
            echo "ğŸ“¦ GÃ©nÃ©ration de package-lock.json..."
            npm install --package-lock-only
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸  Installation terminÃ©e en ${DURATION}s"

      - name: SCA with Snyk
        continue-on-error: true
        run: |
          cd juice-shop
          echo "ğŸ” Scan Snyk en cours..."
          START_TIME=$(date +%s)
          
          # Utiliser snyk global s'il existe
          if command -v snyk &> /dev/null; then
            SNYK_CMD="snyk"
            echo "âœ… Utilisation de snyk global"
          else
            echo "âš ï¸ snyk non trouvÃ©, installation locale..."
            npm install snyk --no-save
            SNYK_CMD="npx snyk"
          fi
          
          $SNYK_CMD test --severity-threshold=low \
            --json-file-output=snyk-results.json || true
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          if [ ! -f "snyk-results.json" ] || [ ! -s "snyk-results.json" ]; then
            echo '{"vulnerabilities":[]}' > snyk-results.json
            echo "âš ï¸ Fichier snyk-results.json crÃ©Ã© (vide)"
          else
            COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
            echo "âœ… Snyk terminÃ© en ${DURATION}s : $COUNT vulnÃ©rabilitÃ©s"
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Monitor
        continue-on-error: true
        run: |
          cd juice-shop
          if command -v snyk &> /dev/null; then
            snyk monitor || true
          else
            npx snyk monitor || true
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SCA results
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: juice-shop/snyk-results.json
          retention-days: 30
          if-no-files-found: warn

# ============================================
# JOB 3 : DAST (ZAP) - 40 minutes max
# ============================================
  dast:
    name: ğŸŒ DAST - ZAP
    runs-on: self-hosted
    timeout-minutes: 40
    needs: [sast, sca]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then 
            echo "âœ… jq dÃ©jÃ  installÃ©"
            exit 0 
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: juice-shop/node_modules
          key: ${{ runner.os }}-modules-${{ hashFiles('juice-shop/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: Install dependencies (production uniquement)
        working-directory: ./juice-shop
        run: |
          if [ ! -d "node_modules" ]; then
            echo "ğŸ“¦ Installation des dÃ©pendances production..."
            if [ -f "package-lock.json" ]; then
              npm ci --prefer-offline --no-audit --no-fund --production || npm install --production
            else
              npm install --production
            fi
          else
            echo "âœ… DÃ©pendances dÃ©jÃ  prÃ©sentes"
          fi

      - name: Check ZAP Docker image
        run: |
          if ! docker image inspect ghcr.io/zaproxy/zaproxy:stable >/dev/null 2>&1; then
            echo "ğŸ“¦ Image ZAP non trouvÃ©e, tÃ©lÃ©chargement..."
            docker pull ghcr.io/zaproxy/zaproxy:stable
          else
            IMAGE_SIZE=$(docker images ghcr.io/zaproxy/zaproxy:stable --format "{{.Size}}" 2>/dev/null || echo "inconnue")
            echo "âœ… Image ZAP dÃ©jÃ  prÃ©sente ($IMAGE_SIZE)"
          fi

      - name: Start Juice Shop
        working-directory: ./juice-shop
        run: |
          # Nettoyage prÃ©alable
          pkill -f "node.*juice-shop" 2>/dev/null || true
          sleep 3
          
          echo "ğŸš€ DÃ©marrage de Juice Shop..."
          npm start &
          echo $! > api.pid
          
          # Health check
          MAX_RETRIES=30
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f http://localhost:3000/ > /dev/null 2>&1; then
              echo "âœ… API prÃªte (tentative $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "â³ Attente... ($i/$MAX_RETRIES)"
            sleep 3
          done
          
          echo "âŒ Ã‰chec du dÃ©marrage"
          exit 1

      - name: DAST - OpenAPI Scan
        continue-on-error: true
        working-directory: ./juice-shop
        run: |
          echo "ğŸ•·ï¸ Scan OpenAPI avec ZAP..."
          
          # DÃ©tection du fichier OpenAPI
          API_FILE=""
          for file in swagger.yml swagger.yaml openapi.json swagger.json; do
            if [ -f "$file" ]; then
              API_FILE="$file"
              echo "ğŸ“„ Fichier trouvÃ©: $file"
              break
            fi
          done
          
          # Scan avec timeout
          if [ -n "$API_FILE" ]; then
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -d /zap/wrk/$API_FILE \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 5 || true
          else
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 5 || true
          fi
          
          # Analyse des rÃ©sultats
          if [ -f "zap-openapi.json" ] && [ -s "zap-openapi.json" ]; then
            ALERTS=$(jq '.site[0].alerts | length' zap-openapi.json 2>/dev/null || echo "0")
            echo "âœ… Scan OpenAPI: $ALERTS alertes"
          fi

      - name: DAST - Active Scan
        continue-on-error: true
        timeout-minutes: 20
        working-directory: ./juice-shop
        run: |
          echo "âš”ï¸ Scan actif ZAP (15-20 minutes)..."
          
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x /zap/wrk/zap-active.xml -J /zap/wrk/zap-active.json \
            -T 15 || true
          
          if [ -f "zap-active.json" ] && [ -s "zap-active.json" ]; then
            ALERTS=$(jq '.site[0].alerts | length' zap-active.json 2>/dev/null || echo "0")
            echo "âœ… Scan actif: $ALERTS alertes"
          fi

      - name: Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          if [ -f api.pid ]; then
            kill $(cat api.pid) 2>/dev/null || true
            rm -f api.pid
          fi
          pkill -f "node.*juice-shop" 2>/dev/null || true
          sleep 2

      - name: Upload DAST results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-results
          path: |
            juice-shop/zap-*.json
            juice-shop/zap-*.xml
          retention-days: 30
          if-no-files-found: warn

# ============================================
# JOB 4 : Consolidation et Import
# ============================================
  import:
    name: ğŸ“Š Consolidation & Import
    runs-on: self-hosted
    needs: [sast, sca, dast]
    timeout-minutes: 5
    
    steps:
      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then 
            echo "âœ… jq dÃ©jÃ  installÃ©"
            exit 0 
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Consolidate results
        run: |
          echo "ğŸ“Š Consolidation des rÃ©sultats..."
          mkdir -p juice-shop security-summary
          
          # Copier tous les rÃ©sultats dans juice-shop/
          find ./artifacts -name "*.json" -exec cp {} juice-shop/ \; 2>/dev/null || true
          find ./artifacts -name "*.xml" -exec cp {} juice-shop/ \; 2>/dev/null || true
          
          # Initialisation des compteurs
          SEMGREP_COUNT=0
          SNYK_COUNT=0
          CRITICAL=0
          HIGH=0
          MEDIUM=0
          LOW=0
          ZAP_COUNT=0
          
          # Analyse Semgrep
          if [ -f "juice-shop/semgrep-results.json" ] && [ -s "juice-shop/semgrep-results.json" ]; then
            SEMGREP_COUNT=$(jq '.results | length' juice-shop/semgrep-results.json 2>/dev/null || echo "0")
            echo "âœ… Semgrep: $SEMGREP_COUNT rÃ©sultats"
          fi
          
          # Analyse Snyk
          if [ -f "juice-shop/snyk-results.json" ] && [ -s "juice-shop/snyk-results.json" ]; then
            SNYK_COUNT=$(jq '.vulnerabilities | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            echo "âœ… Snyk: $SNYK_COUNT vulnÃ©rabilitÃ©s"
          fi
          
          # Analyse ZAP
          if [ -f "juice-shop/zap-active.json" ] && [ -s "juice-shop/zap-active.json" ]; then
            ZAP_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
            echo "âœ… ZAP: $ZAP_COUNT alertes"
          fi
          
          # RÃ©sumÃ© global
          {
            echo "============================================"
            echo "    RAPPORT DE SÃ‰CURITÃ‰ - InvisiThreat"
            echo "============================================"
            echo "ğŸ” SAST (Semgrep): $SEMGREP_COUNT rÃ©sultats"
            echo "ğŸ“¦ SCA (Snyk): $SNYK_COUNT vulnÃ©rabilitÃ©s"
            echo "   â†’ Critiques: $CRITICAL | Hautes: $HIGH | Moyennes: $MEDIUM | Basses: $LOW"
            echo "ğŸŒ DAST (ZAP): $ZAP_COUNT alertes"
            echo "============================================"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
            echo "â±ï¸  Date: $(date)"
            echo "============================================"
          } > security-summary/summary.txt
          
          cat security-summary/summary.txt

      - name: Import to DefectDojo
        continue-on-error: true
        env:
          DD_URL: ${{ secrets.DD_URL }}
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
        run: |
          if [ -z "$DD_URL" ] || [ -z "$DD_API_KEY" ] || [ -z "$PRODUCT_ID" ]; then
            echo "âš ï¸ DefectDojo non configurÃ©, import ignorÃ©"
            exit 0
          fi
          
          echo "ğŸ“¤ Import dans DefectDojo..."
          
          # CrÃ©ation d'un engagement
          ENGAGEMENT_NAME="Scan-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
          echo "CrÃ©ation engagement: $ENGAGEMENT_NAME"
          
          ENGAGEMENT_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "'"$ENGAGEMENT_NAME"'",
              "product": '"$PRODUCT_ID"',
              "target_start": "'$(date +%Y-%m-%d)'",
              "target_end": "'$(date -d "+30 days" +%Y-%m-%d)'",
              "status": "In Progress"
            }')
          
          ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | jq -r '.id // empty')
          
          if [ -z "$ENGAGEMENT_ID" ] || [ "$ENGAGEMENT_ID" = "null" ]; then
            echo "âŒ Ã‰chec crÃ©ation engagement"
            echo "RÃ©ponse: $ENGAGEMENT_RESPONSE"
            exit 0
          fi
          
          echo "âœ… Engagement #$ENGAGEMENT_ID crÃ©Ã©"
          
          # Import des fichiers JSON
          for file in juice-shop/*.json; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              case "$file" in
                *semgrep*) SCAN_TYPE="Semgrep JSON Report" ;;
                *snyk*) SCAN_TYPE="Snyk Scan" ;;
                *zap*) SCAN_TYPE="ZAP Scan" ;;
                *) continue ;;
              esac
              
              echo "ğŸ“¤ Import $SCAN_TYPE..."
              curl -s -X POST "$DD_URL/api/v2/import-scan/" \
                -H "Authorization: Token $DD_API_KEY" \
                -F "engagement=$ENGAGEMENT_ID" \
                -F "scan_type=$SCAN_TYPE" \
                -F "file=@$file" \
                -F "close_old_findings=true" \
                -F "minimum_severity=Info" \
                -F "environment=Development" \
                -F "branch_tag=${{ github.ref_name }}" \
                -F "commit_hash=${{ github.sha }}" \
                -F "build_id=${{ github.run_id }}" > /dev/null && \
                echo "  âœ… Import rÃ©ussi" || echo "  âš ï¸ Ã‰chec import"
            fi
          done
          
          # Import des fichiers XML (ZAP)
          for file in juice-shop/*.xml; do
            if [ -f "$file" ] && [ -s "$file" ]; then
              echo "ğŸ“¤ Import ZAP XML..."
              curl -s -X POST "$DD_URL/api/v2/import-scan/" \
                -H "Authorization: Token $DD_API_KEY" \
                -F "engagement=$ENGAGEMENT_ID" \
                -F "scan_type=ZAP Scan" \
                -F "file=@$file" \
                -F "close_old_findings=true" \
                -F "minimum_severity=Info" \
                -F "environment=Development" \
                -F "branch_tag=${{ github.ref_name }}" \
                -F "commit_hash=${{ github.sha }}" \
                -F "build_id=${{ github.run_id }}" > /dev/null && \
                echo "  âœ… Import rÃ©ussi" || echo "  âš ï¸ Ã‰chec import"
            fi
          done
          
          echo "âœ… Import DefectDojo terminÃ©"

      - name: Upload consolidated summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary/
          retention-days: 30

      - name: Pipeline Summary
        if: always()
        run: |
          echo "ğŸ‰ Pipeline DevSecOps terminÃ© avec succÃ¨s !"
          echo "ğŸ“Š Consultez le rÃ©sumÃ© dans l'artifact 'security-summary'"
          echo "ğŸ“ Tous les rapports sont disponibles dans les artefacts"