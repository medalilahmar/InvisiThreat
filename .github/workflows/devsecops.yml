name: DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: SAST + SCA + DAST
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then exit 0; fi
          sudo killall apt apt-get dpkg 2>/dev/null || true
          sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock /var/lib/apt/lists/lock
          sudo dpkg --configure -a
          if sudo apt update -qq && sudo apt install -y -qq jq; then
            exit 0
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./juice-shop
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
          if [ -d "build" ] || [ -d "dist" ]; then
            echo "Build detected"
          else
            if npm run | grep -q "build"; then
              npm run build || true
            fi
          fi

      - name: SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            /src || true
          if [ ! -f "semgrep-results.json" ]; then
            echo '{"results":[]}' > semgrep-results.json
          fi

      - name: SCA with Snyk
        continue-on-error: true
        run: |
          cd juice-shop
          npx snyk test --severity-threshold=low \
            --json-file-output=snyk-results.json || true
          if [ ! -f "snyk-results.json" ]; then
            echo '{"vulnerabilities":[]}' > snyk-results.json
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Monitor
        continue-on-error: true
        run: |
          cd juice-shop
          npx snyk monitor || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Start Juice Shop
        working-directory: ./juice-shop
        run: |
          if ! grep -q '"start"' package.json; then
            echo "No 'start' script found, skipping API startup."
            exit 1
          fi
          npm start &
          echo $! > api.pid
          MAX_RETRIES=30
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f http://localhost:3000/ > /dev/null; then
              echo "API is up and running."
              exit 0
            fi
            echo "Waiting for API... ($i/$MAX_RETRIES)"
            sleep 5
          done
          echo "API failed to start after $MAX_RETRIES attempts."
          exit 1

      - name: DAST - OpenAPI Scan
        continue-on-error: true
        run: |
          cd juice-shop
          API_FILE=""
          if [ -f "swagger.yml" ]; then
            API_FILE="swagger.yml"
          elif [ -f "swagger.yaml" ]; then
            API_FILE="swagger.yaml"
          elif [ -f "openapi.json" ]; then
            API_FILE="openapi.json"
          fi
          if [ -n "$API_FILE" ]; then
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -d /zap/wrk/$API_FILE \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 120 || true
          else
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 120 || true
          fi

      - name: DAST - Active Scan
        continue-on-error: true
        timeout-minutes: 60
        run: |
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x /zap/wrk/zap-active.xml -J /zap/wrk/zap-active.json -T 30 || true

      - name: Analyze and merge results
        continue-on-error: true
        run: |
          mkdir -p security-summary
          SEMGREP_COUNT=0
          SNYK_COUNT=0
          ZAP_COUNT=0
          if [ -f "juice-shop/semgrep-results.json" ]; then
            SEMGREP_COUNT=$(jq '.results | length' juice-shop/semgrep-results.json 2>/dev/null || echo "0")
            echo "Semgrep: $SEMGREP_COUNT findings" > security-summary/semgrep.txt
          else
            echo "Semgrep: File not found" > security-summary/semgrep.txt
          fi
          if [ -f "juice-shop/snyk-results.json" ]; then
            SNYK_COUNT=$(jq '.vulnerabilities | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            echo "Snyk: $SNYK_COUNT vulnerabilities" > security-summary/snyk.txt
          else
            echo "Snyk: File not found" > security-summary/snyk.txt
          fi
          if [ -f "juice-shop/zap-active.json" ]; then
            ZAP_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
            echo "ZAP Active: $ZAP_COUNT alerts" > security-summary/zap-active.txt
          fi
          if [ -f "juice-shop/zap-openapi.json" ]; then
            ZAP_API_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-openapi.json 2>/dev/null || echo "0")
            echo "ZAP OpenAPI: $ZAP_API_COUNT alerts" > security-summary/zap-openapi.txt
          fi
          {
            echo "----------------------------------------"
            echo "VULNERABILITY SUMMARY"
            echo "----------------------------------------"
            echo "Semgrep (SAST): $SEMGREP_COUNT"
            echo "Snyk (SCA): $SNYK_COUNT"
            echo "ZAP Active (DAST): $ZAP_COUNT"
            echo "----------------------------------------"
          } > security-summary/summary.txt
          cat security-summary/summary.txt

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            juice-shop/semgrep-results.json
            juice-shop/snyk-results.json
            juice-shop/zap-*.json
            juice-shop/zap-*.xml
            security-summary/
          retention-days: 30
          if-no-files-found: warn

      - name: Import to DefectDojo
        if: always()
        continue-on-error: true
        env:
          DD_URL: ${{ secrets.DD_URL }}
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          ENGAGEMENT_ID: ${{ secrets.ENGAGEMENT_ID }}
        run: |
          if [ -z "$DD_URL" ] || [ -z "$DD_API_KEY" ] || [ -z "$ENGAGEMENT_ID" ]; then
            echo "DefectDojo credentials not set, skipping import."
            exit 0
          fi

          # Import Semgrep
          if [ -f "juice-shop/semgrep-results.json" ]; then
            curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@juice-shop/semgrep-results.json" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development" \
              -F "branch_tag=${{ github.ref_name }}" \
              -F "commit_hash=${{ github.sha }}" \
              -F "build_id=${{ github.run_id }}" || true
          fi

          # Import Snyk
          if [ -f "juice-shop/snyk-results.json" ]; then
            curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=Snyk Scan" \
              -F "file=@juice-shop/snyk-results.json" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development" \
              -F "branch_tag=${{ github.ref_name }}" \
              -F "commit_hash=${{ github.sha }}" \
              -F "build_id=${{ github.run_id }}" || true
          fi

          # Import ZAP OpenAPI XML
          if [ -f "juice-shop/zap-openapi.xml" ]; then
            curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=ZAP Scan" \
              -F "file=@juice-shop/zap-openapi.xml" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development" \
              -F "branch_tag=${{ github.ref_name }}" \
              -F "commit_hash=${{ github.sha }}" \
              -F "build_id=${{ github.run_id }}" || true
          fi

          # Import ZAP Active XML
          if [ -f "juice-shop/zap-active.xml" ]; then
            curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=ZAP Scan" \
              -F "file=@juice-shop/zap-active.xml" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development" \
              -F "branch_tag=${{ github.ref_name }}" \
              -F "commit_hash=${{ github.sha }}" \
              -F "build_id=${{ github.run_id }}" || true
          fi

      - name: Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          if [ -f api.pid ]; then
            kill $(cat api.pid) 2>/dev/null || true
            rm -f api.pid
          fi
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "node.*juice-shop" 2>/dev/null || true
          if pgrep -f "node.*juice-shop" > /dev/null; then
            pgrep -f "node.*juice-shop" | xargs kill -9 2>/dev/null || true
          fi