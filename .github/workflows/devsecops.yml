name: ğŸ”’ DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: ğŸ” SAST + SCA + DAST
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ğŸ“¦ Install dependencies
        working-directory: ./juice-shop
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          
          # VÃ©rifier si package-lock.json existe
          if [ -f "package-lock.json" ]; then
            echo "ğŸ“¦ package-lock.json trouvÃ©, utilisation de npm ci..."
            npm ci
          else
            echo "âš ï¸ package-lock.json non trouvÃ©, utilisation de npm install..."
            npm install
          fi
          
          echo "âœ… Installation terminÃ©e"
          
          echo "ğŸ“Š VÃ©rification du build..."
          if [ -d "build" ] || [ -d "dist" ]; then
            echo "âœ… Build dÃ©tectÃ©"
          else
            echo "âš ï¸ Build non trouvÃ© - tentative de build manuel..."
            if npm run | grep -q "build"; then
              npm run build || echo "âš ï¸ Build ignorÃ©"
            else
              echo "â„¹ï¸ Aucun script build trouvÃ©"
            fi
          fi

      - name: ğŸ” SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          echo "ğŸ” Analyse Semgrep en cours..."
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            /src || echo "âš ï¸ Semgrep a rencontrÃ© des erreurs mais continue"
          
          # VÃ©rifier que le fichier a Ã©tÃ© crÃ©Ã©
          if [ -f "semgrep-results.json" ]; then
            echo "âœ… RÃ©sultats Semgrep sauvegardÃ©s"
          else
            echo "âš ï¸ Fichier semgrep-results.json non trouvÃ©"
          fi

      - name: ğŸ” SCA with Snyk
        continue-on-error: true
        run: |
          echo "ğŸ” Analyse Snyk en cours..."
          cd juice-shop
          
          # VÃ©rifier si Snyk est installÃ©
          if ! command -v npx &> /dev/null; then
            echo "âš ï¸ npx non trouvÃ©, installation de npm..."
            apt-get update && apt-get install -y npm || true
          fi
          
          # ExÃ©cuter Snyk avec fallback
          npx snyk test --severity-threshold=low \
            --json-file-output=snyk-results.json || echo "âš ï¸ Snyk a trouvÃ© des vulnÃ©rabilitÃ©s ou a Ã©chouÃ©"
          
          # VÃ©rifier que le fichier a Ã©tÃ© crÃ©Ã©
          if [ -f "snyk-results.json" ]; then
            echo "âœ… RÃ©sultats Snyk sauvegardÃ©s"
          else
            echo "âš ï¸ Fichier snyk-results.json non trouvÃ©, crÃ©ation d'un fichier vide"
            echo '{"vulnerabilities":[]}' > snyk-results.json
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸ” Snyk Monitor (optionnel)
        continue-on-error: true
        run: |
          cd juice-shop
          npx snyk monitor || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸš€ Start Juice Shop
        working-directory: ./juice-shop
        run: |
          echo "ğŸš€ DÃ©marrage de Juice Shop..."
          
          # VÃ©rifier que l'application peut dÃ©marrer
          if ! grep -q '"start"' package.json; then
            echo "âŒ Script 'start' non trouvÃ© dans package.json"
            exit 1
          fi
          
          npm start &
          echo $! > api.pid
          
          # Attendre le dÃ©marrage avec timeout
          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f http://localhost:3000/ > /dev/null; then
              echo "âœ… Juice Shop dÃ©marrÃ© aprÃ¨s $i tentatives"
              exit 0
            fi
            echo "â³ Tentative $i/$MAX_RETRIES..."
            sleep 3
          done
          
          echo "âŒ Ã‰chec du dÃ©marrage aprÃ¨s $MAX_RETRIES tentatives"
          cat api.pid
          exit 1

      - name: ğŸ“‹ DAST - OpenAPI Scan
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Scan OpenAPI en cours..."
          cd juice-shop
          
          # Chercher le fichier OpenAPI/Swagger
          API_FILE=""
          if [ -f "swagger.yml" ]; then
            API_FILE="swagger.yml"
          elif [ -f "swagger.yaml" ]; then
            API_FILE="swagger.yaml"
          elif [ -f "openapi.json" ]; then
            API_FILE="openapi.json"
          fi
          
          if [ -n "$API_FILE" ]; then
            echo "ğŸ“„ Fichier OpenAPI trouvÃ© : $API_FILE"
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -d $API_FILE \
              -x zap-openapi.xml -J zap-openapi.json -T 120 || true
          else
            echo "âš ï¸ Fichier OpenAPI/Swagger non trouvÃ©, scan sans spÃ©cification"
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x zap-openapi.xml -J zap-openapi.json -T 120 || true
          fi

      - name: ğŸ•·ï¸ DAST - Spider Scan
        continue-on-error: true
        run: |
          echo "ğŸ•·ï¸ Scan Spider en cours..."
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:3000 \
            -x zap-spider.xml -J zap-spider.json -T 120 || true

      - name: âš”ï¸ DAST - Active Scan
        continue-on-error: true
        timeout-minutes: 10
        run: |
          echo "âš”ï¸ Scan Actif en cours..."
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x zap-active.xml -J zap-active.json -T 30 || true

      - name: ğŸ“Š Analyser et fusionner les rÃ©sultats
        continue-on-error: true
        run: |
          echo "ğŸ“Š Analyse des rÃ©sultats de sÃ©curitÃ©..."
          
          # CrÃ©er un rÃ©pertoire pour les rapports
          mkdir -p security-summary
          
          # Compteur de vulnÃ©rabilitÃ©s
          SEMGREP_COUNT=0
          SNYK_COUNT=0
          ZAP_COUNT=0
          
          # Analyser Semgrep
          if [ -f "juice-shop/semgrep-results.json" ]; then
            SEMGREP_COUNT=$(jq '.results | length' juice-shop/semgrep-results.json 2>/dev/null || echo "0")
            echo "ğŸ” Semgrep: $SEMGREP_COUNT findings" | tee security-summary/semgrep.txt
          else
            echo "ğŸ” Semgrep: Fichier non trouvÃ©" | tee security-summary/semgrep.txt
          fi
          
          # Analyser Snyk
          if [ -f "juice-shop/snyk-results.json" ]; then
            SNYK_COUNT=$(jq '.vulnerabilities | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            echo "ğŸ” Snyk: $SNYK_COUNT vulnÃ©rabilitÃ©s" | tee security-summary/snyk.txt
          else
            echo "ğŸ” Snyk: Fichier non trouvÃ©" | tee security-summary/snyk.txt
          fi
          
          # Analyser ZAP Active
          if [ -f "juice-shop/zap-active.json" ]; then
            ZAP_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
            echo "âš”ï¸ ZAP Active: $ZAP_COUNT alertes" | tee security-summary/zap-active.txt
          fi
          
          # Analyser ZAP Spider
          if [ -f "juice-shop/zap-spider.json" ]; then
            ZAP_SPIDER_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-spider.json 2>/dev/null || echo "0")
            echo "ğŸ•·ï¸ ZAP Spider: $ZAP_SPIDER_COUNT alertes" | tee security-summary/zap-spider.txt
          fi
          
          # Analyser ZAP OpenAPI
          if [ -f "juice-shop/zap-openapi.json" ]; then
            ZAP_API_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-openapi.json 2>/dev/null || echo "0")
            echo "ğŸ“‹ ZAP OpenAPI: $ZAP_API_COUNT alertes" | tee security-summary/zap-openapi.txt
          fi
          
          # RÃ©sumÃ© global
          echo "----------------------------------------" | tee security-summary/summary.txt
          echo "ğŸ“ˆ RÃ‰SUMÃ‰ DES VULNÃ‰RABILITÃ‰S" | tee -a security-summary/summary.txt
          echo "----------------------------------------" | tee -a security-summary/summary.txt
          echo "Semgrep (SAST): $SEMGREP_COUNT" | tee -a security-summary/summary.txt
          echo "Snyk (SCA): $SNYK_COUNT" | tee -a security-summary/summary.txt
          echo "ZAP Active (DAST): $ZAP_COUNT" | tee -a security-summary/summary.txt
          echo "----------------------------------------" | tee -a security-summary/summary.txt
          
          # Afficher le rÃ©sumÃ©
          cat security-summary/summary.txt

      - name: ğŸ“¤ Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            juice-shop/semgrep-results.json
            juice-shop/snyk-results.json
            juice-shop/zap-*.json
            juice-shop/zap-*.xml
            security-summary/
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ›‘ Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          echo "ğŸ›‘ ArrÃªt de Juice Shop..."
          if [ -f api.pid ]; then
            kill $(cat api.pid) 2>/dev/null && echo "âœ… Processus arrÃªtÃ©" || echo "âš ï¸ Processus dÃ©jÃ  terminÃ©"
            rm -f api.pid
          fi
          
          # Nettoyage supplÃ©mentaire
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "node.*juice-shop" 2>/dev/null || true
          
          # VÃ©rification
          if pgrep -f "node.*juice-shop" > /dev/null; then
            echo "âš ï¸ Certains processus sont encore en cours d'exÃ©cution"
            pgrep -f "node.*juice-shop" | xargs kill -9 2>/dev/null || true
          else
            echo "âœ… Tous les processus sont arrÃªtÃ©s"
          fi