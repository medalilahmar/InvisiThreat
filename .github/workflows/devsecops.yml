name: DevSecOps Pipeline - InvisiThreat (SAST + SCA)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  APP_NAME: InvisiThreat
  APP_DIR: ./juice-shop
  DD_URL: http://localhost:8080
  FAIL_ON_NEW_CRITICAL: "true"
  FAIL_ON_NEW_HIGH: "false"

jobs:
  security:
    name: SAST + SCA + DefectDojo
    runs-on: self-hosted
    timeout-minutes: 60

    steps:

    
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    
    - name: Installer jq
      run: |
        if command -v jq &>/dev/null; then
          echo "OK — jq $(jq --version)"; exit 0
        fi
        sudo killall apt apt-get dpkg 2>/dev/null || true
        sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock \
                   /var/cache/apt/archives/lock /var/lib/apt/lists/lock
        sudo dpkg --configure -a
        if sudo apt-get update -qq && sudo apt-get install -y -qq jq; then
          echo "OK — jq $(jq --version)"
        else
          wget -q -O jq \
            https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq && sudo mv jq /usr/local/bin/
          echo "OK — jq $(jq --version)"
        fi

    
    - name: Cache des dépendances Node
      uses: actions/cache@v4
      id: node-cache
      with:
        path: |
          juice-shop/node_modules
          juice-shop/frontend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('juice-shop/package-lock.json', 'juice-shop/frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Installer les dépendances Node
      working-directory: ${{ env.APP_DIR }}
      run: |
        if [ ! -d "node_modules" ] || [ ! -d "frontend/node_modules" ]; then
          if [ -f "package-lock.json" ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi
        else
          echo "Dépendances en cache — skip installation"
        fi

    
    - name: DefectDojo — Setup
      id: dd_setup
      uses: ./.github/actions/dd-setup
      with:
        dd_url: ${{ env.DD_URL }}
        dd_api_key: ${{ secrets.DEFECTDOJO_API_KEY }}
        app_name: ${{ env.APP_NAME }}
        branch: ${{ github.ref_name }}
        run_id: ${{ github.run_id }}
        sha: ${{ github.sha }}
        repo_url: ${{ github.server_url }}/${{ github.repository }}

    
    - name: DefectDojo — Snapshot AVANT import
      id: dd_snapshot
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        EID="${{ steps.dd_setup.outputs.engagement_id }}"
        DD_BASE="${{ env.DD_URL }}"

        echo "=== SNAPSHOT AVANT IMPORT ==="
        RESP=$(curl -sf \
          "$DD_BASE/api/v2/findings/?engagement=$EID&limit=500&active=true" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Accept: application/json" \
          || echo '{"count":0,"results":[]}')

        BEFORE_TOTAL=$(echo "$RESP" | jq -r '.count // 0')
        BEFORE_CRIT=$(echo "$RESP"  | jq '[.results[]? | select(.severity=="Critical")] | length' 2>/dev/null || echo 0)
        BEFORE_HIGH=$(echo "$RESP"  | jq '[.results[]? | select(.severity=="High")]     | length' 2>/dev/null || echo 0)

        echo "Total=$BEFORE_TOTAL | Critical=$BEFORE_CRIT | High=$BEFORE_HIGH"
        echo "before_total=$BEFORE_TOTAL"   >> "$GITHUB_OUTPUT"
        echo "before_critical=$BEFORE_CRIT" >> "$GITHUB_OUTPUT"
        echo "before_high=$BEFORE_HIGH"     >> "$GITHUB_OUTPUT"

    
    - name: SAST avec Semgrep
      working-directory: ./juice-shop
      continue-on-error: true
      run: |
        [ -f ".semgrepignore" ] && mv .semgrepignore .semgrepignore.bak
        timeout 1500 docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep \
          --config=r/all --json --output=/src/semgrep-results.json \
          --metrics=off --jobs=4 --timeout=60 --max-memory=4096 /src || true
        [ -f ".semgrepignore.bak" ] && mv .semgrepignore.bak .semgrepignore
        [ ! -s semgrep-results.json ] && echo '{"results":[]}' > semgrep-results.json
        COUNT=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo 0)
        echo "Semgrep terminé — $COUNT résultat(s)"

    
    - name: SCA — Snyk test
      working-directory: ${{ env.APP_DIR }}
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        echo "=== SNYK SCAN ==="
        npx snyk test --severity-threshold=low \
          --json-file-output=snyk-results.json || true

        [ ! -s snyk-results.json ] && \
          echo '{"vulnerabilities":[]}' > snyk-results.json

        COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo 0)
        echo "Snyk terminé — $COUNT vulnérabilité(s)"

    - name: SCA — Snyk monitor
      working-directory: ${{ env.APP_DIR }}
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: npx snyk monitor || true

    
    - name: Upload des rapports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: |
          juice-shop/semgrep-results.json
          juice-shop/snyk-results.json
        retention-days: 30
        if-no-files-found: warn

    
    - name: DefectDojo — Import Semgrep
      if: always()
      uses: ./.github/actions/dd-import
      with:
        dd_url: ${{ env.DD_URL }}
        dd_api_key: ${{ secrets.DEFECTDOJO_API_KEY }}
        engagement_id: ${{ steps.dd_setup.outputs.engagement_id }}
        product_name: ${{ env.APP_NAME }}
        engagement_name: ${{ steps.dd_setup.outputs.engagement_name }}
        scan_type: Semgrep JSON Report
        file: ${{ env.APP_DIR }}/semgrep-results.json
        test_title: Semgrep SAST - ${{ github.ref_name }}
        branch: ${{ github.ref_name }}
        sha: ${{ github.sha }}
        run_id: ${{ github.run_id }}

    
    - name: DefectDojo — Import Snyk
      if: always()
      uses: ./.github/actions/dd-import
      with:
        dd_url: ${{ env.DD_URL }}
        dd_api_key: ${{ secrets.DEFECTDOJO_API_KEY }}
        engagement_id: ${{ steps.dd_setup.outputs.engagement_id }}
        product_name: ${{ env.APP_NAME }}
        engagement_name: ${{ steps.dd_setup.outputs.engagement_name }}
        scan_type: Snyk Scan
        file: ${{ env.APP_DIR }}/snyk-results.json
        test_title: Snyk SCA - ${{ github.ref_name }}
        branch: ${{ github.ref_name }}
        sha: ${{ github.sha }}
        run_id: ${{ github.run_id }}

    
    - name: Rapport final et Security Gate
      if: always()
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        EID="${{ steps.dd_setup.outputs.engagement_id }}"
        DD_BASE="${{ env.DD_URL }}"

        RESP=$(curl -sf \
          "$DD_BASE/api/v2/findings/?engagement=$EID&limit=500&active=true" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Accept: application/json" \
          || echo '{"count":0,"results":[]}')

        AFTER_TOTAL=$(echo "$RESP" | jq -r '.count // 0')
        AFTER_CRIT=$(echo "$RESP"  | jq '[.results[]? | select(.severity=="Critical")] | length' 2>/dev/null || echo 0)
        AFTER_HIGH=$(echo "$RESP"  | jq '[.results[]? | select(.severity=="High")]     | length' 2>/dev/null || echo 0)
        AFTER_MED=$(echo "$RESP"   | jq '[.results[]? | select(.severity=="Medium")]   | length' 2>/dev/null || echo 0)
        AFTER_LOW=$(echo "$RESP"   | jq '[.results[]? | select(.severity=="Low")]      | length' 2>/dev/null || echo 0)

        NEW_CRIT=$(( AFTER_CRIT  - ${{ steps.dd_snapshot.outputs.before_critical }} ))
        NEW_HIGH=$(( AFTER_HIGH  - ${{ steps.dd_snapshot.outputs.before_high }} ))
        NEW_TOTAL=$(( AFTER_TOTAL - ${{ steps.dd_snapshot.outputs.before_total }} ))
        [ "$NEW_CRIT" -lt 0 ] && NEW_CRIT=0
        [ "$NEW_HIGH" -lt 0 ] && NEW_HIGH=0

        echo ""
        echo "========================================================"
        echo "  RAPPORT SECURITE"
        echo "========================================================"
        echo "  Produit    : ${{ env.APP_NAME }} (ID=${{ steps.dd_setup.outputs.product_id }})"
        echo "  Engagement : ${{ steps.dd_setup.outputs.engagement_name }} (ID=$EID)"
        echo "  Période    : ${{ steps.dd_setup.outputs.start_date }} → ${{ steps.dd_setup.outputs.end_date }}"
        echo "  Branche    : ${{ github.ref_name }}"
        echo "  Commit     : ${{ github.sha }}"
        echo ""
        echo "  ÉVOLUTION : ${{ steps.dd_snapshot.outputs.before_total }} → $AFTER_TOTAL ($NEW_TOTAL nouveau(x))"
        echo ""
        echo "  FINDINGS ACTIFS :"
        echo "    Critical : $AFTER_CRIT  (nouveaux: $NEW_CRIT)"
        echo "    High     : $AFTER_HIGH  (nouveaux: $NEW_HIGH)"
        echo "    Medium   : $AFTER_MED"
        echo "    Low      : $AFTER_LOW"
        echo ""
        echo "  Lien : $DD_BASE/engagements/$EID/finding/"
        echo "========================================================"

        # Security Gate
        FAILED=false
        [ "${{ env.FAIL_ON_NEW_CRITICAL }}" = "true" ] && [ "$NEW_CRIT" -gt 0 ] && \
          { echo "SECURITY GATE ECHEC : $NEW_CRIT nouveau(x) Critical !"; FAILED=true; }
        [ "${{ env.FAIL_ON_NEW_HIGH }}" = "true" ]     && [ "$NEW_HIGH" -gt 0 ] && \
          { echo "SECURITY GATE ECHEC : $NEW_HIGH nouveau(x) High !"; FAILED=true; }

        [ "$FAILED" = "true" ] && exit 1
        echo "Security Gate : OK"

    
    - name: Résumé pipeline
      if: always()
      run: |
        echo "========================================================"
        echo "  DEVSECOPS PIPELINE — ${{ env.APP_NAME }}"
        echo "========================================================"
        echo "  Produit    : ${{ env.APP_NAME }} (ID=${{ steps.dd_setup.outputs.product_id }})"
        echo "  Engagement : ${{ steps.dd_setup.outputs.engagement_name }} (ID=${{ steps.dd_setup.outputs.engagement_id }})"
        echo "  Période    : ${{ steps.dd_setup.outputs.start_date }} → ${{ steps.dd_setup.outputs.end_date }}"
        echo "  Branche    : ${{ github.ref_name }}"
        echo "  Commit     : ${{ github.sha }}"
        echo "  Run ID     : ${{ github.run_id }}"
        echo "  Lien       : ${{ env.DD_URL }}/engagements/${{ steps.dd_setup.outputs.engagement_id }}/finding/"
        echo "========================================================"