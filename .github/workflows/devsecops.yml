name: DevSecOps Pipeline - InvisiThreat (TEST RAPIDE)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DD_URL: http://localhost:8080
  PERIOD_MODE: "quarterly"
  FAIL_ON_NEW_CRITICAL: "true"
  FAIL_ON_NEW_HIGH: "false"

jobs:
  security:
    name: SAST + SCA + DAST + DefectDojo
    runs-on: self-hosted
    timeout-minutes: 30

    steps:

    - name: Recuperer le code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Installer jq
      run: |
        if command -v jq &> /dev/null; then
          echo "jq deja installe: $(jq --version)"
          exit 0
        fi
        sudo killall apt apt-get dpkg 2>/dev/null || true
        sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock \
                   /var/cache/apt/archives/lock /var/lib/apt/lists/lock
        sudo dpkg --configure -a
        if sudo apt update -qq && sudo apt install -y -qq jq; then
          echo "jq installe via apt: $(jq --version)"
        else
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq && sudo mv jq /usr/local/bin/
          echo "jq installe via binaire: $(jq --version)"
        fi

    - name: Installer les dependances Node
      working-directory: ./juice-shop
      run: |
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi

    - name: SAST avec Semgrep
      working-directory: ./juice-shop
      continue-on-error: true
      run: |
        [ -f ".semgrepignore" ] && mv .semgrepignore .semgrepignore.bak
        timeout 120 docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep \
          --config=r/javascript.lang.security \
          --json --output=/src/semgrep-results.json \
          --metrics=off --jobs=2 --timeout=30 /src || true
        [ -f ".semgrepignore.bak" ] && mv .semgrepignore.bak .semgrepignore
        [ ! -s "semgrep-results.json" ] && echo '{"results":[]}' > semgrep-results.json
        echo "Semgrep termine"
        jq -r '"  Total: " + (.results | length | tostring)' semgrep-results.json

    - name: Snyk SCA
      continue-on-error: true
      working-directory: ./juice-shop
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        npx snyk test --severity-threshold=low \
          --json-file-output=snyk-results.json || true
        if [ ! -f "snyk-results.json" ] || [ ! -s "snyk-results.json" ]; then
          echo '{"vulnerabilities":[]}' > snyk-results.json
        fi
        COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
        echo "Snyk termine : $COUNT vulnerabilites"

    - name: Snyk Monitor
      continue-on-error: true
      working-directory: ./juice-shop
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: npx snyk monitor || true

    - name: Generer rapports ZAP factices
      working-directory: ./juice-shop
      run: |
        echo "Generation des rapports ZAP factices..."

        printf '%s\n' \
          '<?xml version="1.0"?>' \
          '<OWASPZAPReport version="2.11.1" generated="Mon, 24 Feb 2025 00:00:00">' \
          '  <site name="http://localhost:3000" host="localhost" port="3000" ssl="false">' \
          '    <alerts>' \
          '      <alertitem>' \
          '        <pluginid>10038</pluginid>' \
          '        <alert>Content Security Policy Header Not Set</alert>' \
          '        <n>Content Security Policy Header Not Set</n>' \
          '        <riskcode>2</riskcode>' \
          '        <confidence>3</confidence>' \
          '        <riskdesc>Medium (High)</riskdesc>' \
          '        <desc>CSP header is missing.</desc>' \
          '        <solution>Set the Content-Security-Policy header.</solution>' \
          '        <reference>https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP</reference>' \
          '        <cweid>693</cweid>' \
          '        <wascid>15</wascid>' \
          '        <instances>' \
          '          <instance>' \
          '            <uri>http://localhost:3000/</uri>' \
          '            <method>GET</method>' \
          '            <evidence></evidence>' \
          '          </instance>' \
          '        </instances>' \
          '        <count>1</count>' \
          '      </alertitem>' \
          '      <alertitem>' \
          '        <pluginid>10021</pluginid>' \
          '        <alert>X-Content-Type-Options Header Missing</alert>' \
          '        <n>X-Content-Type-Options Header Missing</n>' \
          '        <riskcode>1</riskcode>' \
          '        <confidence>3</confidence>' \
          '        <riskdesc>Low (High)</riskdesc>' \
          '        <desc>X-Content-Type-Options header is not set.</desc>' \
          '        <solution>Set the Content-Type header appropriately.</solution>' \
          '        <reference>https://owasp.org/www-project-secure-headers/</reference>' \
          '        <cweid>693</cweid>' \
          '        <wascid>15</wascid>' \
          '        <instances>' \
          '          <instance>' \
          '            <uri>http://localhost:3000/</uri>' \
          '            <method>GET</method>' \
          '            <evidence></evidence>' \
          '          </instance>' \
          '        </instances>' \
          '        <count>1</count>' \
          '      </alertitem>' \
          '    </alerts>' \
          '  </site>' \
          '</OWASPZAPReport>' \
          > zap-openapi.xml

        cp zap-openapi.xml zap-spider.xml
        cp zap-openapi.xml zap-active.xml

        printf '%s\n' \
          '[{"pluginid":"10038","alert":"CSP Header Not Set","riskcode":"2"},' \
          '{"pluginid":"10021","alert":"X-Content-Type-Options Missing","riskcode":"1"}]' \
          > zap-openapi.json
        cp zap-openapi.json zap-spider.json
        cp zap-openapi.json zap-active.json

        echo "Fichiers generes :"
        ls -lh zap-*.xml zap-*.json

    - name: Consolider les rapports DAST
      working-directory: ./juice-shop
      run: |
        echo "[]" > zap-consolidated.json
        if ls zap-*.json 1> /dev/null 2>&1; then
          jq -s 'add' zap-*.json > zap-consolidated.json 2>/dev/null || echo "[]" > zap-consolidated.json
        fi
        TOTAL=$(jq 'length' zap-consolidated.json 2>/dev/null || echo "0")
        echo "DAST consolide : $TOTAL alertes"

    - name: Upload tous les rapports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: |
          juice-shop/semgrep-results.json
          juice-shop/snyk-results.json
          juice-shop/zap-*.json
          juice-shop/zap-*.xml
        retention-days: 30
        if-no-files-found: warn

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # DEFECTDOJO â€” CREATION PRODUIT + ENGAGEMENT
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: DefectDojo - Creer Produit et Engagement
      if: always()
      id: dd_setup
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        PRODUCT_NAME: "InvisiThreat"
      run: |
        set -e
        
        # Fonction d'encodage URL
        urlencode() {
          local string="$1" encoded="" i
          for (( i=0; i<${#string}; i++ )); do
            local c="${string:$i:1}"
            case "$c" in
              [a-zA-Z0-9._~-]) encoded+="$c" ;;
              ' ') encoded+="%20" ;;
              *) encoded+=$(printf '%%%02X' "'$c") ;;
            esac
          done
          echo "$encoded"
        }
        
        # â”€â”€ 1. GESTION DU PRODUIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        echo "ðŸ” Recherche du produit: $PRODUCT_NAME..."
        ENC_PRODUCT=$(urlencode "$PRODUCT_NAME")
        
        SEARCH_P=$(curl -s \
          "${DD_URL}/api/v2/products/?name=${ENC_PRODUCT}" \
          -H "Authorization: Token $DD_API_KEY")
        
        COUNT_P=$(echo "$SEARCH_P" | jq -r '.count // 0')
        
        if [ "$COUNT_P" -gt "0" ]; then
          # Produit existant
          PRODUCT_ID=$(echo "$SEARCH_P" | jq -r '.results[0].id')
          echo "âœ… Produit existant - ID: $PRODUCT_ID"
          PRODUCT_STATUS="exists"
        else
          # Creation du produit
          echo "ðŸ“¦ Creation du produit: $PRODUCT_NAME"
          PAYLOAD_P=$(jq -n \
            --arg name "$PRODUCT_NAME" \
            --arg desc "Produit pour les scans de securite InvisiThreat" \
            '{
              name: $name,
              description: $desc,
              prod_type: 1
            }')
          
          CREATE_P=$(curl -s -X POST "${DD_URL}/api/v2/products/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD_P")
          
          PRODUCT_ID=$(echo "$CREATE_P" | jq -r '.id // empty')
          
          if [ -z "$PRODUCT_ID" ] || [ "$PRODUCT_ID" = "null" ]; then
            echo "âŒ Echec creation produit. Reponse API :"
            echo "$CREATE_P" | jq .
            exit 1
          fi
          echo "âœ… Produit cree - ID: $PRODUCT_ID"
          PRODUCT_STATUS="created"
        fi
        
        # â”€â”€ 2. GESTION DE L'ENGAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        BRANCH="${{ github.ref_name }}"
        
        # Calcul de la periode
        if [ "$PERIOD_MODE" = "quarterly" ]; then
          MONTH=$(date +%-m)
          YEAR=$(date +%Y)
          if   [ $MONTH -le 3 ]; then PERIOD="Q1"; PERIOD_START="${YEAR}-01-01"; PERIOD_END="${YEAR}-03-31"
          elif [ $MONTH -le 6 ]; then PERIOD="Q2"; PERIOD_START="${YEAR}-04-01"; PERIOD_END="${YEAR}-06-30"
          elif [ $MONTH -le 9 ]; then PERIOD="Q3"; PERIOD_START="${YEAR}-07-01"; PERIOD_END="${YEAR}-09-30"
          else                        PERIOD="Q4"; PERIOD_START="${YEAR}-10-01"; PERIOD_END="${YEAR}-12-31"
          fi
          ENGAGEMENT_NAME="${BRANCH} - ${YEAR}-${PERIOD}"
        elif [ "$PERIOD_MODE" = "monthly" ]; then
          PERIOD=$(date +%Y-%m)
          PERIOD_START=$(date +%Y-%m-01)
          PERIOD_END=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%Y-%m-%d)
          ENGAGEMENT_NAME="${BRANCH} - ${PERIOD}"
        elif [ "$PERIOD_MODE" = "weekly" ]; then
          PERIOD="W$(date +%V)-$(date +%Y)"
          PERIOD_START=$(date -d "last Monday" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          PERIOD_END=$(date -d "next Sunday" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          ENGAGEMENT_NAME="${BRANCH} - ${PERIOD}"
        fi
        
        echo ""
        echo "ðŸ“… Engagement: $ENGAGEMENT_NAME"
        echo "   Periode: $PERIOD_START -> $PERIOD_END"
        
        ENC_ENGAGEMENT=$(urlencode "$ENGAGEMENT_NAME")
        ENC_STATUS=$(urlencode "In Progress")
        
        # Recherche engagement existant
        SEARCH_E=$(curl -s \
          "${DD_URL}/api/v2/engagements/?product=${PRODUCT_ID}&name=${ENC_ENGAGEMENT}&status=${ENC_STATUS}" \
          -H "Authorization: Token $DD_API_KEY")
        
        COUNT_E=$(echo "$SEARCH_E" | jq -r '.count // 0')
        
        if [ "$COUNT_E" -gt "0" ]; then
          # Engagement existant
          ENGAGEMENT_ID=$(echo "$SEARCH_E" | jq -r '.results | sort_by(.id) | reverse | .[0].id')
          echo "â™»ï¸ Engagement existant - ID: $ENGAGEMENT_ID"
          
          # Mise a jour de la date de fin
          curl -s -X PATCH "${DD_URL}/api/v2/engagements/${ENGAGEMENT_ID}/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"target_end\": \"${PERIOD_END}\"}" > /dev/null
          
          ENGAGEMENT_STATUS="reused"
        else
          # Creation engagement
          echo "ðŸ†• Creation engagement: $ENGAGEMENT_NAME"
          PAYLOAD_E=$(jq -n \
            --arg name       "$ENGAGEMENT_NAME" \
            --arg desc       "Scans CI/CD | Branche: ${BRANCH} | Periode: ${PERIOD_START} -> ${PERIOD_END}" \
            --argjson product "$PRODUCT_ID" \
            --arg start       "$PERIOD_START" \
            --arg end         "$PERIOD_END" \
            --arg branch      "$BRANCH" \
            '{
              name:                        $name,
              description:                 $desc,
              product:                     $product,
              engagement_type:             "CI/CD",
              status:                      "In Progress",
              target_start:                $start,
              target_end:                  $end,
              branch_tag:                  $branch,
              deduplication_on_engagement: false,
              tags: ["github-actions", $branch, "automated"]
            }')
          
          CREATE_E=$(curl -s -X POST "${DD_URL}/api/v2/engagements/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD_E")
          
          ENGAGEMENT_ID=$(echo "$CREATE_E" | jq -r '.id // empty')
          
          if [ -z "$ENGAGEMENT_ID" ] || [ "$ENGAGEMENT_ID" = "null" ]; then
            echo "âŒ Echec creation engagement. Reponse API :"
            echo "$CREATE_E" | jq .
            exit 1
          fi
          echo "âœ… Engagement cree - ID: $ENGAGEMENT_ID"
          ENGAGEMENT_STATUS="created"
        fi
        
        # â”€â”€ 3. EXPORT DES VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          echo "PRODUCT_ID=$PRODUCT_ID"
          echo "PRODUCT_NAME=$PRODUCT_NAME"
          echo "PRODUCT_STATUS=$PRODUCT_STATUS"
          echo "ENGAGEMENT_ID=$ENGAGEMENT_ID"
          echo "ENGAGEMENT_NAME=$ENGAGEMENT_NAME"
          echo "ENGAGEMENT_STATUS=$ENGAGEMENT_STATUS"
          echo "BRANCH=$BRANCH"
          echo "PERIOD=$PERIOD"
          echo "PERIOD_START=$PERIOD_START"
          echo "PERIOD_END=$PERIOD_END"
        } >> $GITHUB_ENV
        
        echo "product_id=$PRODUCT_ID" >> $GITHUB_OUTPUT
        echo "engagement_id=$ENGAGEMENT_ID" >> $GITHUB_OUTPUT
        
        echo ""
        echo "======================================="
        echo "  PRODUIT: $PRODUCT_NAME (ID: $PRODUCT_ID)"
        echo "  ENGAGEMENT: $ENGAGEMENT_NAME (ID: $ENGAGEMENT_ID)"
        echo "======================================="

    - name: DefectDojo - Snapshot avant import
      if: always()
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        echo "Capture des findings AVANT reimport..."
        TOTAL=$(curl -s \
          "${DD_URL}/api/v2/findings/?engagement=${ENGAGEMENT_ID}&active=true&limit=1" \
          -H "Authorization: Token $DD_API_KEY" | jq -r '.count // 0')
        echo "FINDINGS_BEFORE=$TOTAL" >> $GITHUB_ENV

        for SEV in Critical High Medium Low Info; do
          COUNT=$(curl -s \
            "${DD_URL}/api/v2/findings/?engagement=${ENGAGEMENT_ID}&active=true&severity=${SEV}&limit=1" \
            -H "Authorization: Token $DD_API_KEY" | jq -r '.count // 0')
          echo "BEFORE_${SEV}=$COUNT" >> $GITHUB_ENV
          echo "  - $SEV : $COUNT"
        done
        echo "Total avant : $TOTAL findings actifs"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # DEFECTDOJO â€” REIMPORT DES SCANS
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: DefectDojo - Reimport des scans
      if: always()
      continue-on-error: true
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        reimport_scan() {
          local file="$1"
          local scan_type="$2"
          local test_title="$3"
          local category="$4"

          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "    $test_title - fichier absent ou vide, skip"
            return 0
          fi

          echo "  Import de $test_title..."
          echo "    - Engagement ID: $ENGAGEMENT_ID"
          echo "    - Fichier: $file ($(stat -c%s "$file" 2>/dev/null || echo "0") octets)"

          # Construction de la commande curl sans backslash problÃ©matique
          CURL_CMD="curl -s -X POST \"${DD_URL}/api/v2/reimport-scan/\""
          CURL_CMD="$CURL_CMD -H \"Authorization: Token $DD_API_KEY\""
          CURL_CMD="$CURL_CMD -F \"engagement=${ENGAGEMENT_ID}\""
          CURL_CMD="$CURL_CMD -F \"scan_type=${scan_type}\""
          CURL_CMD="$CURL_CMD -F \"test_title=${test_title}\""
          CURL_CMD="$CURL_CMD -F \"file=@${file}\""
          CURL_CMD="$CURL_CMD -F \"active=true\""
          CURL_CMD="$CURL_CMD -F \"verified=false\""
          CURL_CMD="$CURL_CMD -F \"close_old_findings=true\""
          CURL_CMD="$CURL_CMD -F \"close_old_findings_product_scope=false\""
          CURL_CMD="$CURL_CMD -F \"minimum_severity=Info\""
          CURL_CMD="$CURL_CMD -F \"environment=Development\""
          CURL_CMD="$CURL_CMD -F \"branch_tag=${{ github.ref_name }}\""
          CURL_CMD="$CURL_CMD -F \"commit_hash=${{ github.sha }}\""
          CURL_CMD="$CURL_CMD -F \"build_id=${{ github.run_id }}\""
          CURL_CMD="$CURL_CMD -F \"tags=${category},github-actions,automated\""
          CURL_CMD="$CURL_CMD 2>&1"

          # ExÃ©cution de la commande
          RESPONSE=$(eval $CURL_CMD) || true

          # Parsing de la rÃ©ponse
          TEST_ID=$(echo "$RESPONSE" | jq -r '.test // .id // empty' 2>/dev/null || echo "")
          NEW_F=$(echo "$RESPONSE" | jq -r '.finding_count // 0' 2>/dev/null || echo "0")
          CLOSED_F=$(echo "$RESPONSE" | jq -r '.closed_findings // 0' 2>/dev/null || echo "0")
          SKIP_F=$(echo "$RESPONSE" | jq -r '.skipped_findings // 0' 2>/dev/null || echo "0")

          if [ -n "$TEST_ID" ] && [ "$TEST_ID" != "null" ]; then
            echo "  âœ… $test_title | Test ID: $TEST_ID | new=$NEW_F closed=$CLOSED_F skipped=$SKIP_F"
          else
            echo "  âŒ $test_title | Ã‰chec import"
            echo "    RÃ©ponse API :"
            echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"
          fi
        }

        echo "================================================"
        echo "  SAST - Semgrep"
        echo "================================================"
        reimport_scan \
          "juice-shop/semgrep-results.json" \
          "Semgrep JSON Report" \
          "SAST - Semgrep" \
          "SAST"

        echo ""
        echo "================================================"
        echo "  SCA - Snyk"
        echo "================================================"
        reimport_scan \
          "juice-shop/snyk-results.json" \
          "Snyk Scan" \
          "SCA - Snyk" \
          "SCA"

        echo ""
        echo "================================================"
        echo "  DAST - ZAP"
        echo "================================================"
        reimport_scan \
          "juice-shop/zap-openapi.xml" \
          "ZAP Scan" \
          "DAST - ZAP OpenAPI" \
          "DAST"

        reimport_scan \
          "juice-shop/zap-spider.xml" \
          "ZAP Scan" \
          "DAST - ZAP Spider" \
          "DAST"

        reimport_scan \
          "juice-shop/zap-active.xml" \
          "ZAP Scan" \
          "DAST - ZAP Active Scan" \
          "DAST"

    - name: DefectDojo - Rapport final et Security Gate
      if: always()
      env:
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      run: |
        echo ""
        echo "=========================================================="
        echo "  DEFECTDOJO - RAPPORT DE SECURITE CI/CD"
        echo "=========================================================="
        echo "  Produit    : $PRODUCT_NAME (ID: $PRODUCT_ID)"
        echo "  Engagement : $ENGAGEMENT_NAME"
        if [ "$ENGAGEMENT_STATUS" = "created" ]; then
          echo "  Statut     : Cree ce run"
        else
          echo "  Statut     : Reutilise (existant)"
        fi
        echo "  Lien       : ${DD_URL}/engagements/${ENGAGEMENT_ID}/finding/"
        echo ""

        printf "  %-14s | %5s | %5s | %s\n" "Severite" "Avant" "Apres" "Delta"
        echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

        GATE_FAILED=0
        NEW_CRITICAL=0
        NEW_HIGH=0

        for SEV in Critical High Medium Low Info; do
          AFTER=$(curl -s \
            "${DD_URL}/api/v2/findings/?engagement=${ENGAGEMENT_ID}&active=true&severity=${SEV}&limit=1" \
            -H "Authorization: Token $DD_API_KEY" | jq -r '.count // 0')

          BEFORE_VAR="BEFORE_${SEV}"
          BEFORE="${!BEFORE_VAR}"
          BEFORE="${BEFORE:-0}"
          DELTA=$((AFTER - BEFORE))

          case "$SEV" in
            Critical) ICON="C" ;;
            High)     ICON="H" ;;
            Medium)   ICON="M" ;;
            Low)      ICON="L" ;;
            Info)     ICON="I" ;;
          esac

          if [ "$DELTA" -gt 0 ]; then
            DELTA_STR="+${DELTA} [NEW]"
          elif [ "$DELTA" -lt 0 ]; then
            DELTA_STR="${DELTA} [FIXED]"
          else
            DELTA_STR="  -"
          fi

          printf "  [%s] %-12s | %5s | %5s | %s\n" "$ICON" "$SEV" "$BEFORE" "$AFTER" "$DELTA_STR"

          if [ "$SEV" = "Critical" ] && [ "$DELTA" -gt 0 ]; then NEW_CRITICAL=$DELTA; fi
          if [ "$SEV" = "High" ]     && [ "$DELTA" -gt 0 ]; then NEW_HIGH=$DELTA;     fi
        done

        echo ""
        echo "  Total actifs avant ce run : $FINDINGS_BEFORE"
        TOTAL_AFTER=$(curl -s \
          "${DD_URL}/api/v2/findings/?engagement=${ENGAGEMENT_ID}&active=true&limit=1" \
          -H "Authorization: Token $DD_API_KEY" | jq -r '.count // 0')
        echo "  Total actifs apres ce run : $TOTAL_AFTER"

        TOTAL_DIFF=$((TOTAL_AFTER - FINDINGS_BEFORE))
        if   [ "$TOTAL_DIFF" -eq 0 ]; then echo "  Aucun changement detecte."
        elif [ "$TOTAL_DIFF" -gt 0 ]; then echo "  [+] $TOTAL_DIFF nouveau(x) finding(s) !"
        else
          ABS=$((TOTAL_DIFF * -1))
          echo "  [OK] $ABS finding(s) resolu(s) !"
        fi

        echo ""
        echo "=========================================================="

        if [ "$FAIL_ON_NEW_CRITICAL" = "true" ] && [ "$NEW_CRITICAL" -gt 0 ]; then
          echo "SECURITY GATE FAILED ! $NEW_CRITICAL CRITICAL introduit(s)."
          GATE_FAILED=1
        fi
        if [ "$FAIL_ON_NEW_HIGH" = "true" ] && [ "$NEW_HIGH" -gt 0 ]; then
          echo "SECURITY GATE FAILED ! $NEW_HIGH HIGH introduit(s)."
          GATE_FAILED=1
        fi
        [ "$GATE_FAILED" -eq 0 ] && echo "Security Gate : PASSED"

        exit $GATE_FAILED

    - name: Pipeline termine
      if: always()
      run: |
        echo "DevSecOps pipeline termine"
        echo "  Branche    : ${{ github.ref_name }}"
        echo "  Commit     : ${{ github.sha }}"
        echo "  Run ID     : ${{ github.run_id }}"
        echo "  Produit    : $PRODUCT_NAME (ID: $PRODUCT_ID)"
        echo "  Engagement : $ENGAGEMENT_NAME (ID: $ENGAGEMENT_ID)"
        echo "  Lien       : ${DD_URL}/engagements/${ENGAGEMENT_ID}/finding/"