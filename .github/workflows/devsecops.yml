name: üîí DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: üîç SAST + SCA + DAST + DefectDojo
    runs-on: self-hosted
    timeout-minutes: 120
    
    steps:
    - name: üì• R√©cup√©rer le code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: üì¶ Installer jq (sans blocage)
      run: |
        if command -v jq &> /dev/null; then
          echo "‚úÖ jq d√©j√† install√©: $(jq --version)"
          exit 0
        fi
        
        echo "üîß Nettoyage des processus apt bloqu√©s..."
        sudo killall apt apt-get dpkg 2>/dev/null || true
        sudo rm -f /var/lib/dpkg/lock-frontend
        sudo rm -f /var/lib/dpkg/lock
        sudo rm -f /var/cache/apt/archives/lock
        sudo rm -f /var/lib/apt/lists/lock
        sudo dpkg --configure -a
        
        echo "üì¶ Tentative d'installation via apt..."
        if sudo apt update -qq && sudo apt install -y -qq jq; then
          echo "‚úÖ jq install√© avec apt: $(jq --version)"
        else
          echo "‚ö†Ô∏è √âchec apt, installation directe du binaire..."
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/
          echo "‚úÖ jq install√© via binaire: $(jq --version)"
        fi

    - name: üì¶ Installer les d√©pendances
      working-directory: ./juice-shop
      run: |
        if [ -f "package-lock.json" ]; then
          echo "üì¶ Installation avec npm ci..."
          npm ci
        else
          echo "üì¶ Installation avec npm install..."
          npm install
        fi

    - name: üîç SAST avec Semgrep
      working-directory: ./juice-shop
      continue-on-error: true
      run: |
        echo "üîç Scan Semgrep en cours..."
        docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
          --config=p/security-audit \
          --config=p/owasp-top-ten \
          --json \
          --output=semgrep-results.json \
          /src || true
        
        if [ ! -f "semgrep-results.json" ]; then
          echo '{"results":[]}' > semgrep-results.json
          echo "‚ö†Ô∏è Fichier semgrep-results.json cr√©√© (vide)"
        else
          COUNT=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
          echo "‚úÖ Semgrep termin√© : $COUNT r√©sultats trouv√©s"
        fi

    - name: üì¶ Snyk SCA
      continue-on-error: true
      working-directory: ./juice-shop
      run: |
        echo "üîç Scan Snyk en cours..."
        
        # Utiliser npx pour snyk
        npx snyk test --severity-threshold=low \
          --json-file-output=snyk-results.json || true
        
        if [ ! -f "snyk-results.json" ] || [ ! -s "snyk-results.json" ]; then
          echo '{"vulnerabilities":[]}' > snyk-results.json
          echo "‚ö†Ô∏è Fichier snyk-results.json cr√©√© (vide)"
        else
          COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
          echo "‚úÖ Snyk termin√© : $COUNT vuln√©rabilit√©s trouv√©es"
        fi
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: üìä Snyk Monitor
      continue-on-error: true
      working-directory: ./juice-shop
      run: |
        echo "üìä Envoi des donn√©es √† Snyk Monitor..."
        npx snyk monitor || true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: üöÄ D√©marrer l'API en arri√®re-plan
      working-directory: ./juice-shop
      run: |
        echo "üöÄ D√©marrage de l'API sur http://localhost:3000"
        npm start &
        echo $! > api.pid
        sleep 15
        
        MAX_RETRIES=20
        for i in $(seq 1 $MAX_RETRIES); do
          if curl -s -f http://localhost:3000/ > /dev/null 2>&1; then
            echo "‚úÖ API d√©marr√©e avec succ√®s"
            exit 0
          fi
          echo "‚è≥ Tentative $i/$MAX_RETRIES..."
          sleep 3
        done
        echo "‚ùå API n'a pas d√©marr√©"
        exit 1

    - name: üìã DAST - Scan OpenAPI
      continue-on-error: true
      working-directory: ./juice-shop
      run: |
        echo "üï∑Ô∏è Scan OpenAPI avec ZAP..."
        
        # D√©tection du fichier OpenAPI
        API_FILE=""
        for file in swagger.yml swagger.yaml openapi.json swagger.json; do
          if [ -f "$file" ]; then
            API_FILE="$file"
            echo "üìÑ Fichier OpenAPI trouv√©: $file"
            break
          fi
        done
        
        if [ -n "$API_FILE" ]; then
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t http://localhost:3000 \
            -f openapi \
            -d /zap/wrk/$API_FILE \
            -x /zap/wrk/zap-openapi.xml \
            -J /zap/wrk/zap-openapi.json \
            -T 30 || true
        else
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t http://localhost:3000 \
            -f openapi \
            -x /zap/wrk/zap-openapi.xml \
            -J /zap/wrk/zap-openapi.json \
            -T 30 || true
        fi

    - name: üíæ V√©rifier rapport OpenAPI
      working-directory: ./juice-shop
      run: |
        if [ -f zap-openapi.json ]; then
          echo "‚úÖ Fichier trouv√©: zap-openapi.json"
        elif [ -f zap_out.json ]; then
          echo "‚úÖ Fichier trouv√©: zap_out.json"
          cp zap_out.json zap-openapi.json
        elif [ -f report_json.json ]; then
          echo "‚úÖ Fichier trouv√©: report_json.json"
          cp report_json.json zap-openapi.json
        else
          echo "‚ö†Ô∏è Aucun rapport trouv√©"
          echo "[]" > zap-openapi.json
        fi

    - name: üï∑Ô∏è DAST - Spider Scan
      continue-on-error: true
      working-directory: ./juice-shop
      run: |
        echo "üï∑Ô∏è Spider Scan avec ZAP..."
        docker run --rm --network host -v $(pwd):/zap/wrk:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py \
          -t http://localhost:3000 \
          -x /zap/wrk/zap-spider.xml \
          -J /zap/wrk/zap-spider.json \
          -T 10 || true

    - name: üíæ Sauvegarder rapport Spider
      working-directory: ./juice-shop
      run: |
        if [ -f zap-spider.json ]; then
          echo "‚úÖ Rapport Spider sauvegard√©"
        elif [ -f zap-out.json ]; then
          cp zap-out.json zap-spider.json
          echo "‚úÖ Rapport Spider sauvegard√©"
        else
          echo "‚ö†Ô∏è Aucun rapport Spider trouv√©"
        fi

    - name: ‚öîÔ∏è DAST - Active Scan
      continue-on-error: true
      timeout-minutes: 40
      working-directory: ./juice-shop
      run: |
        echo "‚öîÔ∏è Scan actif avec ZAP (peut prendre 30-40 minutes)..."
        docker run --rm --network host -v $(pwd):/zap/wrk:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t http://localhost:3000 \
          -x /zap/wrk/zap-active.xml \
          -J /zap/wrk/zap-active.json \
          -T 30 || true

    - name: üíæ Sauvegarder rapport Active Scan
      working-directory: ./juice-shop
      run: |
        if [ -f zap-active.json ]; then
          echo "‚úÖ Rapport Active Scan sauvegard√©"
        elif [ -f zap-out.json ]; then
          cp zap-out.json zap-active.json
          echo "‚úÖ Rapport Active Scan sauvegard√©"
        else
          echo "‚ö†Ô∏è Aucun rapport Active Scan trouv√©"
        fi

    - name: üîÄ Consolider les rapports DAST
      working-directory: ./juice-shop
      run: |
        echo "üîÄ Consolidation des rapports DAST..."
        
        echo "[]" > zap-consolidated.json
        
        if ls zap-*.json 1> /dev/null 2>&1; then
          jq -s 'add' zap-*.json > zap-consolidated.json 2>/dev/null || echo "[]" > zap-consolidated.json
        fi
        
        if [ -s zap-consolidated.json ]; then
          TOTAL=$(jq 'length' zap-consolidated.json 2>/dev/null || echo "0")
          CRITICAL=$(jq '[.[] | select(.riskcode=="3")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.[] | select(.riskcode=="2")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.[] | select(.riskcode=="1")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          LOW=$(jq '[.[] | select(.riskcode=="0")] | length' zap-consolidated.json 2>/dev/null || echo "0")
          
          echo "üìä R√âSULTATS DAST:"
          echo "   Total: $TOTAL vuln√©rabilit√©s"
          echo "   üî¥ Critiques: $CRITICAL"
          echo "   üü† Hautes: $HIGH"
          echo "   üü° Moyennes: $MEDIUM"
          echo "   üü¢ Basses: $LOW"
        else
          echo "‚ö†Ô∏è Aucune vuln√©rabilit√© d√©tect√©e"
        fi

    - name: üõë Arr√™ter l'API
      if: always()
      working-directory: ./juice-shop
      run: |
        echo "üõë Arr√™t de l'API..."
        if [ -f api.pid ]; then
          PID=$(cat api.pid)
          kill $PID 2>/dev/null || true
          rm -f api.pid
          echo "‚úÖ API arr√™t√©e (PID: $PID)"
        fi
        pkill -f "node.*juice-shop" || true
        echo "‚úÖ Nettoyage des processus termin√©"

    - name: üì§ Upload tous les rapports de s√©curit√©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: |
          juice-shop/semgrep-results.json
          juice-shop/snyk-results.json
          juice-shop/zap-*.json
          juice-shop/zap-*.xml
        retention-days: 30
        if-no-files-found: warn

    - name: üì§ Importer dans DefectDojo
      if: always()
      continue-on-error: true
      env:
        DD_URL: ${{ secrets.DD_URL }}
        DD_API_KEY: ${{ secrets.DD_API_KEY }}
        PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
      run: |
        ENGAGEMENT_ID=1
        
        echo "üîç V√©rification des fichiers JSON..."
        
        # IMPORT SEMGREP
        if [ -f juice-shop/semgrep-results.json ] && [ -s juice-shop/semgrep-results.json ]; then
          echo "üì§ Import Semgrep (Engagement #$ENGAGEMENT_ID)..."
          SEMGREP_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=Semgrep JSON Report" \
            -F "file=@juice-shop/semgrep-results.json" \
            -F "close_old_findings=true" \
            -F "minimum_severity=Info" \
            -F "environment=Development" \
            -F "branch_tag=${{ github.ref_name }}" \
            -F "commit_hash=${{ github.sha }}" \
            -F "build_id=${{ github.run_id }}")
          
          if echo "$SEMGREP_RESPONSE" | grep -q "id"; then
            echo "‚úÖ Semgrep import√© avec succ√®s !"
          else
            echo "‚ö†Ô∏è R√©ponse Semgrep: $SEMGREP_RESPONSE"
          fi
        else
          echo "‚ö†Ô∏è Fichier semgrep-results.json non trouv√©"
        fi
        
        # IMPORT SNYK
        if [ -f juice-shop/snyk-results.json ] && [ -s juice-shop/snyk-results.json ]; then
          echo "üì§ Import Snyk (Engagement #$ENGAGEMENT_ID)..."
          SNYK_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=Snyk Scan" \
            -F "file=@juice-shop/snyk-results.json" \
            -F "close_old_findings=true" \
            -F "minimum_severity=Info" \
            -F "environment=Development" \
            -F "branch_tag=${{ github.ref_name }}" \
            -F "commit_hash=${{ github.sha }}" \
            -F "build_id=${{ github.run_id }}")
          
          if echo "$SNYK_RESPONSE" | grep -q "id"; then
            echo "‚úÖ Snyk import√© avec succ√®s !"
          else
            echo "‚ö†Ô∏è R√©ponse Snyk: $SNYK_RESPONSE"
          fi
        else
          echo "‚ö†Ô∏è Fichier snyk-results.json non trouv√©"
        fi

        echo "üì§ Import des rapports ZAP (XML)..."

        # Import OpenAPI XML
        if [ -f juice-shop/zap-openapi.xml ] && [ -s juice-shop/zap-openapi.xml ]; then
          curl -s -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=ZAP Scan" \
            -F "file=@juice-shop/zap-openapi.xml" \
            -F "close_old_findings=true"
          echo "‚úÖ ZAP OpenAPI import√©"
        fi  

        # Import Spider XML
        if [ -f juice-shop/zap-spider.xml ] && [ -s juice-shop/zap-spider.xml ]; then
          curl -s -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=ZAP Scan" \
            -F "file=@juice-shop/zap-spider.xml" \
            -F "close_old_findings=true"
          echo "‚úÖ ZAP Spider import√©"
        fi

        # Import Active XML
        if [ -f juice-shop/zap-active.xml ] && [ -s juice-shop/zap-active.xml ]; then
          curl -s -X POST "$DD_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DD_API_KEY" \
            -F "engagement=$ENGAGEMENT_ID" \
            -F "scan_type=ZAP Scan" \
            -F "file=@juice-shop/zap-active.xml" \
            -F "close_old_findings=true"
          echo "‚úÖ ZAP Active import√©"
        fi

    - name: üéâ Pipeline termin√©
      run: echo "‚úÖ DevSecOps pipeline ex√©cut√© avec succ√®s sur runner self-hosted"