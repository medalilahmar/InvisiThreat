name: ðŸ”’ DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: ðŸ” SAST + SCA + DAST
    runs-on: self-hosted

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Install dependencies
        working-directory: ./juice-shop
        run: |
          # VÃ©rifier si package-lock.json existe
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ðŸ—ï¸ Build project
        working-directory: ./juice-shop
        run: npm run build

      - name: ðŸ” SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep --config=p/security-audit --json --output=semgrep-results.json /src || true

      - name: ðŸ“¦ Snyk SCA
        working-directory: ./juice-shop
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          npm install -g snyk
          snyk test --severity-threshold=low --json-file-output=snyk-results.json || true

      - name: ðŸš€ Start Juice Shop
        working-directory: ./juice-shop
        run: |
          npm start &
          echo $! > api.pid
          sleep 15
          for i in {1..10}; do
            if curl -s -f http://localhost:3000/ > /dev/null; then
              echo "âœ… Juice Shop dÃ©marrÃ©"
              exit 0
            fi
            echo "â³ Tentative $i/10..."
            sleep 3
          done
          echo "âŒ Ã‰chec du dÃ©marrage"
          exit 1

      - name: ðŸ“‹ DAST - OpenAPI Scan
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          docker run --rm --network host -v $(pwd):/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py -t http://localhost:3000 -f openapi -d swagger.yml \
            -x zap-openapi.xml -J zap-openapi.json -T 120 || true

      - name: ðŸ•·ï¸ DAST - Spider Scan
        continue-on-error: true
        run: |
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:3000 \
            -x zap-spider.xml -J zap-spider.json -T 300 || true

      - name: âš”ï¸ DAST - Active Scan
        continue-on-error: true
        run: |
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x zap-active.xml -J zap-active.json -T 60 || true

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            juice-shop/semgrep-results.json
            juice-shop/snyk-results.json
            juice-shop/zap-*.json
            juice-shop/zap-*.xml

      - name: ðŸ›‘ Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          if [ -f api.pid ]; then
            kill $(cat api.pid) 2>/dev/null || true
            rm -f api.pid
          fi
          pkill -f "node.*server.js" || true