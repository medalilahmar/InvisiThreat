name: DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: SAST + SCA + DAST
    runs-on: self-hosted
    timeout-minutes: 120  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install jq
        run: |
          if command -v jq >/dev/null 2>&1; then 
            echo "âœ… jq dÃ©jÃ  installÃ©"
            exit 0 
          fi
          echo "ğŸ“¦ Installation de jq..."
          sudo killall apt apt-get dpkg 2>/dev/null || true
          sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock /var/lib/apt/lists/lock
          sudo dpkg --configure -a
          if sudo apt update -qq && sudo apt install -y -qq jq; then
            echo "âœ… jq installÃ© avec apt"
            exit 0
          fi
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/
          echo "âœ… jq installÃ© via binaire"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: juice-shop/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('juice-shop/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./juice-shop
        run: |
          if [ ! -d "node_modules" ] || [ ! -f "node_modules/.install-complete" ]; then
            echo "ğŸ“¦ Installation des dÃ©pendances..."
            if [ -f "package-lock.json" ]; then
              npm ci
            else
              npm install
            fi
            touch node_modules/.install-complete
          else
            echo "âœ… DÃ©pendances dÃ©jÃ  installÃ©es (cache)"
          fi
          
          # VÃ©rifier s'il y a une Ã©tape de build
          if [ -d "build" ] || [ -d "dist" ]; then
            echo "ğŸ“¦ Build dÃ©tectÃ©"
          else
            if npm run | grep -q "build"; then
              echo "ğŸ”¨ ExÃ©cution du build..."
              npm run build || true
            fi
          fi

      - name: SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          echo "ğŸ” Scan Semgrep en cours..."
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            /src || true
          
          if [ ! -f "semgrep-results.json" ]; then
            echo '{"results":[]}' > semgrep-results.json
            echo "âš ï¸ Fichier semgrep-results.json crÃ©Ã© (vide)"
          else
            COUNT=$(jq '.results | length' semgrep-results.json)
            echo "âœ… Semgrep terminÃ© : $COUNT rÃ©sultats trouvÃ©s"
          fi

      - name: SCA with Snyk
        continue-on-error: true
        run: |
          cd juice-shop
          echo "ğŸ” Scan Snyk en cours..."
          
          # Installer Snyk localement si nÃ©cessaire
          if ! command -v snyk &> /dev/null && [ ! -d "node_modules/snyk" ]; then
            npm install snyk --no-save
          fi
          
          npx snyk test --severity-threshold=low \
            --json-file-output=snyk-results.json || true
          
          if [ ! -f "snyk-results.json" ]; then
            echo '{"vulnerabilities":[]}' > snyk-results.json
            echo "âš ï¸ Fichier snyk-results.json crÃ©Ã© (vide)"
          else
            if [ -s "snyk-results.json" ]; then
              COUNT=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
              echo "âœ… Snyk terminÃ© : $COUNT vulnÃ©rabilitÃ©s trouvÃ©es"
            fi
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Monitor
        continue-on-error: true
        run: |
          cd juice-shop
          echo "ğŸ“Š Envoi des donnÃ©es Ã  Snyk Monitor..."
          npx snyk monitor || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Start Juice Shop
        working-directory: ./juice-shop
        run: |
          if ! grep -q '"start"' package.json; then
            echo "âŒ Script 'start' non trouvÃ© dans package.json"
            exit 1
          fi
          
          echo "ğŸš€ DÃ©marrage de Juice Shop sur http://localhost:3000"
          npm start &
          echo $! > api.pid
          
          MAX_RETRIES=30
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f http://localhost:3000/ > /dev/null 2>&1; then
              echo "âœ… API dÃ©marrÃ©e avec succÃ¨s (tentative $i/$MAX_RETRIES)"
              exit 0
            fi
            echo "â³ Attente du dÃ©marrage de l'API... ($i/$MAX_RETRIES)"
            sleep 5
          done
          
          echo "âŒ Ã‰chec du dÃ©marrage de l'API aprÃ¨s $MAX_RETRIES tentatives"
          exit 1

      - name: DAST - OpenAPI Scan
        continue-on-error: true
        run: |
          cd juice-shop
          echo "ğŸ•·ï¸ Scan OpenAPI avec ZAP..."
          
          # DÃ©tection automatique du fichier OpenAPI
          API_FILE=""
          if [ -f "swagger.yml" ]; then
            API_FILE="swagger.yml"
            echo "ğŸ“„ Fichier OpenAPI trouvÃ©: swagger.yml"
          elif [ -f "swagger.yaml" ]; then
            API_FILE="swagger.yaml"
            echo "ğŸ“„ Fichier OpenAPI trouvÃ©: swagger.yaml"
          elif [ -f "openapi.json" ]; then
            API_FILE="openapi.json"
            echo "ğŸ“„ Fichier OpenAPI trouvÃ©: openapi.json"
          elif [ -f "swagger.json" ]; then
            API_FILE="swagger.json"
            echo "ğŸ“„ Fichier OpenAPI trouvÃ©: swagger.json"
          else
            echo "âš ï¸ Aucun fichier OpenAPI trouvÃ©, scan sans spÃ©cification"
          fi
          
          if [ -n "$API_FILE" ]; then
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -d /zap/wrk/$API_FILE \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 10 || true
          else
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x /zap/wrk/zap-openapi.xml -J /zap/wrk/zap-openapi.json -T 10 || true
          fi
          
          # VÃ©rification des rÃ©sultats
          if [ -f "zap-openapi.json" ]; then
            if [ -s "zap-openapi.json" ]; then
              ALERTS=$(jq '.site[0].alerts | length' zap-openapi.json 2>/dev/null || echo "0")
              echo "âœ… Scan OpenAPI terminÃ© : $ALERTS alertes trouvÃ©es"
            else
              echo "âš ï¸ Fichier zap-openapi.json vide"
            fi
          else
            echo "âš ï¸ Fichier zap-openapi.json non gÃ©nÃ©rÃ©"
          fi

      - name: DAST - Active Scan
        continue-on-error: true
        timeout-minutes: 30
        run: |
          echo "âš”ï¸ Scan actif avec ZAP (peut prendre jusqu'Ã  30 minutes)..."
          
          # CrÃ©er le rÃ©pertoire de sortie s'il n'existe pas
          mkdir -p juice-shop
          
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x /zap/wrk/zap-active.xml -J /zap/wrk/zap-active.json -T 20 || true
          
          # VÃ©rification des rÃ©sultats
          if [ -f "juice-shop/zap-active.json" ]; then
            if [ -s "juice-shop/zap-active.json" ]; then
              ALERTS=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
              echo "âœ… Scan actif terminÃ© : $ALERTS alertes trouvÃ©es"
            else
              echo "âš ï¸ Fichier zap-active.json vide"
            fi
          else
            echo "âš ï¸ Fichier zap-active.json non gÃ©nÃ©rÃ©"
          fi

      - name: Analyze and merge results
        continue-on-error: true
        run: |
          echo "ğŸ“Š Analyse et consolidation des rÃ©sultats..."
          mkdir -p security-summary
          
          # Semgrep
          if [ -f "juice-shop/semgrep-results.json" ]; then
            SEMGREP_COUNT=$(jq '.results | length' juice-shop/semgrep-results.json 2>/dev/null || echo "0")
            echo "Semgrep: $SEMGREP_COUNT findings" > security-summary/semgrep.txt
            echo "âœ… Semgrep: $SEMGREP_COUNT rÃ©sultats"
          else
            echo "Semgrep: File not found" > security-summary/semgrep.txt
            echo "âš ï¸ Semgrep: fichier non trouvÃ©"
            SEMGREP_COUNT=0
          fi
          
          # Snyk
          if [ -f "juice-shop/snyk-results.json" ]; then
            if [ -s "juice-shop/snyk-results.json" ]; then
              SNYK_COUNT=$(jq '.vulnerabilities | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
              echo "Snyk: $SNYK_COUNT vulnerabilities" > security-summary/snyk.txt
              echo "âœ… Snyk: $SNYK_COUNT vulnÃ©rabilitÃ©s"
              
              # Analyse par sÃ©vÃ©ritÃ©
              CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
              HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.vulnerabilities[] | select(.severity=="medium")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
              LOW=$(jq '[.vulnerabilities[] | select(.severity=="low")] | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            else
              echo "Snyk: 0 vulnerabilities" > security-summary/snyk.txt
              SNYK_COUNT=0
            fi
          else
            echo "Snyk: File not found" > security-summary/snyk.txt
            echo "âš ï¸ Snyk: fichier non trouvÃ©"
            SNYK_COUNT=0
          fi
          
          # ZAP Active
          ZAP_COUNT=0
          if [ -f "juice-shop/zap-active.json" ]; then
            if [ -s "juice-shop/zap-active.json" ]; then
              ZAP_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
              echo "ZAP Active: $ZAP_COUNT alerts" > security-summary/zap-active.txt
              echo "âœ… ZAP Active: $ZAP_COUNT alertes"
              
              # Analyse par risque
              CRITICAL_ZAP=$(jq '[.site[0].alerts[] | select(.riskcode=="3")] | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
              HIGH_ZAP=$(jq '[.site[0].alerts[] | select(.riskcode=="2")] | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
              MEDIUM_ZAP=$(jq '[.site[0].alerts[] | select(.riskcode=="1")] | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
              LOW_ZAP=$(jq '[.site[0].alerts[] | select(.riskcode=="0")] | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
            fi
          else
            echo "ZAP Active: No file" > security-summary/zap-active.txt
          fi
          
          # ZAP OpenAPI
          ZAP_API_COUNT=0
          if [ -f "juice-shop/zap-openapi.json" ]; then
            if [ -s "juice-shop/zap-openapi.json" ]; then
              ZAP_API_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-openapi.json 2>/dev/null || echo "0")
              echo "ZAP OpenAPI: $ZAP_API_COUNT alerts" > security-summary/zap-openapi.txt
            fi
          fi
          
          # RÃ©sumÃ© global
          {
            echo "========================================"
            echo "    RAPPORT DE SÃ‰CURITÃ‰ - InvisiThreat"
            echo "========================================"
            echo "Semgrep (SAST): $SEMGREP_COUNT rÃ©sultats"
            echo "Snyk (SCA): $SNYK_COUNT vulnÃ©rabilitÃ©s"
            if [ -n "$CRITICAL" ]; then
              echo "  â†’ Critiques: $CRITICAL | Hautes: $HIGH | Moyennes: $MEDIUM | Basses: $LOW"
            fi
            echo "ZAP Active (DAST): $ZAP_COUNT alertes"
            if [ -n "$CRITICAL_ZAP" ]; then
              echo "  â†’ Critiques: $CRITICAL_ZAP | Hautes: $HIGH_ZAP | Moyennes: $MEDIUM_ZAP | Basses: $LOW_ZAP"
            fi
            echo "ZAP OpenAPI: $ZAP_API_COUNT alertes"
            echo "========================================"
            echo "Commit: ${{ github.sha }}"
            echo "Branche: ${{ github.ref_name }}"
            echo "Date: $(date)"
            echo "========================================"
          } > security-summary/summary.txt
          
          cat security-summary/summary.txt

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            juice-shop/semgrep-results.json
            juice-shop/snyk-results.json
            juice-shop/zap-*.json
            juice-shop/zap-*.xml
            security-summary/
          retention-days: 30
          if-no-files-found: warn

      - name: Import to DefectDojo
        if: always()
        continue-on-error: true
        env:
          DD_URL: ${{ secrets.DD_URL }}
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
        run: |
          if [ -z "$DD_URL" ] || [ -z "$DD_API_KEY" ] || [ -z "$PRODUCT_ID" ]; then
            echo "âš ï¸ DefectDojo credentials not set, skipping import."
            exit 0
          fi
          
          echo "ğŸ“¤ Import des rÃ©sultats dans DefectDojo..."
          
          # CrÃ©er un engagement pour ce build
          ENGAGEMENT_NAME="Scan-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
          echo "CrÃ©ation de l'engagement: $ENGAGEMENT_NAME"
          
          ENGAGEMENT_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
            -H "Authorization: Token $DD_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "'"$ENGAGEMENT_NAME"'",
              "product": '"$PRODUCT_ID"',
              "target_start": "'$(date +%Y-%m-%d)'",
              "target_end": "'$(date -d "+30 days" +%Y-%m-%d)'",
              "status": "In Progress",
              "branch_tag": "'"${{ github.ref_name }}"'",
              "build_id": "'"${{ github.run_id }}"'",
              "commit_hash": "'"${{ github.sha }}"'",
              "source_code_management_uri": "https://github.com/${{ github.repository }}"
            }')
          
          ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | jq -r '.id // empty')
          
          if [ -z "$ENGAGEMENT_ID" ] || [ "$ENGAGEMENT_ID" = "null" ]; then
            echo "âŒ Ã‰chec de crÃ©ation de l'engagement"
            echo "RÃ©ponse: $ENGAGEMENT_RESPONSE"
            exit 0
          fi
          
          echo "âœ… Engagement crÃ©Ã© avec ID: $ENGAGEMENT_ID"
          
          # Import Semgrep
          if [ -f "juice-shop/semgrep-results.json" ] && [ -s "juice-shop/semgrep-results.json" ]; then
            echo "ğŸ“¤ Import Semgrep..."
            RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@juice-shop/semgrep-results.json" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development")
            
            if echo "$RESPONSE" | grep -q "id"; then
              echo "  âœ… Semgrep importÃ©"
            else
              echo "  âš ï¸ Ã‰chec import Semgrep: $RESPONSE"
            fi
          else
            echo "âš ï¸ Fichier semgrep-results.json non trouvÃ© ou vide"
          fi
          
          # Import Snyk
          if [ -f "juice-shop/snyk-results.json" ] && [ -s "juice-shop/snyk-results.json" ]; then
            echo "ğŸ“¤ Import Snyk..."
            RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=Snyk Scan" \
              -F "file=@juice-shop/snyk-results.json" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development")
            
            if echo "$RESPONSE" | grep -q "id"; then
              echo "  âœ… Snyk importÃ©"
            else
              echo "  âš ï¸ Ã‰chec import Snyk: $RESPONSE"
            fi
          else
            echo "âš ï¸ Fichier snyk-results.json non trouvÃ© ou vide"
          fi
          
          # Import ZAP OpenAPI
          if [ -f "juice-shop/zap-openapi.xml" ] && [ -s "juice-shop/zap-openapi.xml" ]; then
            echo "ğŸ“¤ Import ZAP OpenAPI..."
            RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=ZAP Scan" \
              -F "file=@juice-shop/zap-openapi.xml" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development")
            
            if echo "$RESPONSE" | grep -q "id"; then
              echo "  âœ… ZAP OpenAPI importÃ©"
            else
              echo "  âš ï¸ Ã‰chec import ZAP OpenAPI: $RESPONSE"
            fi
          fi
          
          # Import ZAP Active
          if [ -f "juice-shop/zap-active.xml" ] && [ -s "juice-shop/zap-active.xml" ]; then
            echo "ğŸ“¤ Import ZAP Active..."
            RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DD_API_KEY" \
              -F "engagement=$ENGAGEMENT_ID" \
              -F "scan_type=ZAP Scan" \
              -F "file=@juice-shop/zap-active.xml" \
              -F "close_old_findings=true" \
              -F "minimum_severity=Info" \
              -F "environment=Development")
            
            if echo "$RESPONSE" | grep -q "id"; then
              echo "  âœ… ZAP Active importÃ©"
            else
              echo "  âš ï¸ Ã‰chec import ZAP Active: $RESPONSE"
            fi
          fi
          
          echo "âœ… Import DefectDojo terminÃ© pour l'engagement #$ENGAGEMENT_ID"

      - name: Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          echo "ğŸ›‘ ArrÃªt de Juice Shop..."
          
          if [ -f api.pid ]; then
            PID=$(cat api.pid)
            if kill -0 $PID 2>/dev/null; then
              kill $PID 2>/dev/null || true
              echo "âœ… Processus arrÃªtÃ© (PID: $PID)"
            fi
            rm -f api.pid
          fi
          
          # Nettoyage supplÃ©mentaire
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "node.*juice-shop" 2>/dev/null || true
          
          # Force kill si nÃ©cessaire
          if pgrep -f "node.*juice-shop" > /dev/null; then
            echo "âš ï¸ Force kill des processus restants..."
            pgrep -f "node.*juice-shop" | xargs kill -9 2>/dev/null || true
          fi
          
          echo "âœ… Nettoyage terminÃ©"

      - name: Pipeline Summary
        if: always()
        run: |
          echo "ğŸ‰ Pipeline DevSecOps terminÃ© !"
          echo "ğŸ“Š Consultez le rÃ©sumÃ© dans security-summary/summary.txt"
          echo "ğŸ“ Les rapports sont disponibles dans les artefacts"