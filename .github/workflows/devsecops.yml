name: ğŸ”’ DevSecOps Pipeline - InvisiThreat

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security:
    name: ğŸ” SAST + SCA + DAST
    runs-on: self-hosted
    timeout-minutes: 30  # Ã‰vite les timeouts infinis

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # Pour une analyse complÃ¨te

      - name: ğŸ“¦ Install dependencies
        working-directory: ./juice-shop
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          npm ci  # Plus fiable et reproductible que npm install
          echo "âœ… Installation terminÃ©e"
          
          echo "ğŸ“Š VÃ©rification du build..."
          if [ -d "build" ] || [ -d "dist" ]; then
            echo "âœ… Build dÃ©tectÃ©"
          else
            echo "âš ï¸ Build non trouvÃ© - tentative de build manuel..."
            npm run build || echo "âš ï¸ Build ignorÃ©"
          fi

      - name: ğŸ” SAST with Semgrep
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          echo "ğŸ” Analyse Semgrep en cours..."
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            /src || echo "âš ï¸ Semgrep a rencontrÃ© des erreurs mais continue"

      - name: ğŸ” SCA with Snyk
        continue-on-error: true
        run: |
          echo "ğŸ” Analyse Snyk en cours..."
          # Utiliser npx au lieu de l'installation globale
          cd juice-shop
          npx snyk test --severity-threshold=low \
            --json-file-output=snyk-results.json || echo "âš ï¸ Snyk a trouvÃ© des vulnÃ©rabilitÃ©s"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸ” Snyk Monitor (optionnel)
        continue-on-error: true
        run: |
          cd juice-shop
          npx snyk monitor || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸš€ Start Juice Shop
        working-directory: ./juice-shop
        run: |
          echo "ğŸš€ DÃ©marrage de Juice Shop..."
          npm start &
          echo $! > api.pid
          
          # Attendre le dÃ©marrage avec timeout
          MAX_RETRIES=15
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -s -f http://localhost:3000/ > /dev/null; then
              echo "âœ… Juice Shop dÃ©marrÃ© aprÃ¨s $i tentatives"
              exit 0
            fi
            echo "â³ Tentative $i/$MAX_RETRIES..."
            sleep 3
          done
          
          echo "âŒ Ã‰chec du dÃ©marrage aprÃ¨s $MAX_RETRIES tentatives"
          cat api.pid
          exit 1

      - name: ğŸ“‹ DAST - OpenAPI Scan
        working-directory: ./juice-shop
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Scan OpenAPI en cours..."
          if [ ! -f "swagger.yml" ] && [ ! -f "swagger.yaml" ] && [ ! -f "openapi.json" ]; then
            echo "âš ï¸ Fichier OpenAPI/Swagger non trouvÃ©, tentative de dÃ©tection..."
            # Alternative : utiliser le scan standard
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x zap-openapi.xml -J zap-openapi.json -T 120 || true
          else
            docker run --rm --network host -v $(pwd):/zap/wrk:rw \
              ghcr.io/zaproxy/zaproxy:stable \
              zap-api-scan.py -t http://localhost:3000 -f openapi \
              -x zap-openapi.xml -J zap-openapi.json -T 120 || true
          fi

      - name: ğŸ•·ï¸ DAST - Spider Scan
        continue-on-error: true
        run: |
          echo "ğŸ•·ï¸ Scan Spider en cours..."
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:3000 \
            -x zap-spider.xml -J zap-spider.json -T 120 || true

      - name: âš”ï¸ DAST - Active Scan
        continue-on-error: true
        timeout-minutes: 10  # Timeout spÃ©cifique pour cette Ã©tape
        run: |
          echo "âš”ï¸ Scan Actif en cours..."
          docker run --rm --network host -v $(pwd)/juice-shop:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py -t http://localhost:3000 \
            -x zap-active.xml -J zap-active.json -T 30 || true

      - name: ğŸ“Š Analyser et fusionner les rÃ©sultats
        continue-on-error: true
        run: |
          echo "ğŸ“Š Analyse des rÃ©sultats de sÃ©curitÃ©..."
          
          # Compteur de vulnÃ©rabilitÃ©s
          SEMGREP_COUNT=0
          SNYK_COUNT=0
          ZAP_COUNT=0
          
          if [ -f "juice-shop/semgrep-results.json" ]; then
            SEMGREP_COUNT=$(jq '.results | length' juice-shop/semgrep-results.json 2>/dev/null || echo "0")
            echo "ğŸ” Semgrep: $SEMGREP_COUNT findings"
          fi
          
          if [ -f "juice-shop/snyk-results.json" ]; then
            SNYK_COUNT=$(jq '.vulnerabilities | length' juice-shop/snyk-results.json 2>/dev/null || echo "0")
            echo "ğŸ” Snyk: $SNYK_COUNT vulnÃ©rabilitÃ©s"
          fi
          
          if [ -f "juice-shop/zap-active.json" ]; then
            ZAP_COUNT=$(jq '.site[0].alerts | length' juice-shop/zap-active.json 2>/dev/null || echo "0")
            echo "âš”ï¸ ZAP: $ZAP_COUNT alertes"
          fi
          
          # RÃ©sumÃ©
          echo "----------------------------------------"
          echo "ğŸ“ˆ RÃ‰SUMÃ‰ DES VULNÃ‰RABILITÃ‰S"
          echo "----------------------------------------"
          echo "Semgrep (SAST): $SEMGREP_COUNT"
          echo "Snyk (SCA): $SNYK_COUNT"
          echo "ZAP (DAST): $ZAP_COUNT"
          echo "----------------------------------------"
          
          # Seuil de qualitÃ© (optionnel)
          # if [ $SEMGREP_COUNT -gt 10 ] || [ $SNYK_COUNT -gt 20 ] || [ $ZAP_COUNT -gt 30 ]; then
          #   echo "âš ï¸ Seuil de qualitÃ© dÃ©passÃ©!"
          #   exit 1
          # fi

      - name: ğŸ“¤ Upload security reports
        if: always()  # Toujours uploader mÃªme en cas d'Ã©chec
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            juice-shop/semgrep-results.json
            juice-shop/snyk-results.json
            juice-shop/zap-*.json
            juice-shop/zap-*.xml
          retention-days: 30  # Conservation des rapports

      - name: ğŸ›‘ Stop Juice Shop
        if: always()
        working-directory: ./juice-shop
        run: |
          echo "ğŸ›‘ ArrÃªt de Juice Shop..."
          if [ -f api.pid ]; then
            kill $(cat api.pid) 2>/dev/null && echo "âœ… Processus arrÃªtÃ©" || echo "âš ï¸ Processus dÃ©jÃ  terminÃ©"
            rm -f api.pid
          fi
          # Nettoyage supplÃ©mentaire
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "node.*juice-shop" 2>/dev/null || true
          
          # VÃ©rification
          if pgrep -f "node.*juice-shop" > /dev/null; then
            echo "âš ï¸ Certains processus sont encore en cours d'exÃ©cution"
            pgrep -f "node.*juice-shop" | xargs kill -9 2>/dev/null || true
          else
            echo "âœ… Tous les processus sont arrÃªtÃ©s"
          fi